<div class="space-y-3">
  <div *ngFor="let s of shifts; let i = index" class="rounded-lg border border-gray-200 dark:border-gray-700 p-3 transition-colors duration-150" [ngClass]="i % 2 === 0 ? 'bg-white shift-bg-even' : 'bg-gray-50 shift-bg-odd'">
    <div class="flex items-center justify-between">
      <div class="font-medium text-gray-800 dark:text-gray-200 flex flex-wrap items-center gap-x-2 gap-y-1">
        <span *ngIf="s.rowId !== undefined" class="text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400">#{{ s.rowId }}</span>
        <span>{{ s.service || 'Shift' }}</span>
        <span>· #{{ s.number }}</span>
        <span>· {{ s.date }}</span>
      </div>
      <div class="flex gap-2">
        <button mat-mini-fab color="primary" (click)="onAddTrip(s.id)" aria-label="Add Trip">
          <mat-icon>add</mat-icon>
        </button>
        <button mat-mini-fab color="accent" (click)="onEditShift(s.id)" aria-label="Edit Shift">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-mini-fab (click)="toggleExpanded(s.id)" aria-label="Toggle Details">
          <mat-icon>{{ isExpanded(s.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>
    </div>

    <div class="mt-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 overflow-hidden shadow-sm">
      <div class="flex items-center justify-between px-3 py-2 bg-white dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
        <div class="text-xs font-semibold tracking-wide uppercase text-gray-700 dark:text-gray-300 flex items-center gap-1">
          <mat-icon fontSet="material-icons" style="font-size:16px" class="text-gray-500 dark:text-gray-400">list</mat-icon>
          Trips
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-300 flex items-center gap-3">
          <span>{{ counts[s.key] || 0 }} items</span>
          <span *ngIf="tripTotals[s.key] !== undefined">${{ tripTotals[s.key] | number:'1.2-2' }}</span>
          <button mat-button color="primary" (click)="toggleTrips(s.id)" class="!text-xs !py-0 !min-w-0">
            {{ isShowTrips(s.id) ? 'Hide' : 'Show' }}
          </button>
        </div>
      </div>
      <div *ngIf="isShowTrips(s.id) && tripsByKey[s.key] && tripsByKey[s.key].length; else noTrips" class="divide-y divide-gray-200 dark:divide-gray-600">
        <div *ngFor="let t of tripsByKey[s.key]" class="px-3 py-2 bg-white dark:bg-gray-700 flex flex-col gap-1">
          <div class="flex justify-between text-sm">
            <div class="font-medium text-gray-800 dark:text-gray-200 flex items-center gap-1 flex-wrap">
              <mat-icon fontSet="material-icons" class="text-gray-500 dark:text-gray-400" style="font-size:16px">local_taxi</mat-icon>
              <span *ngIf="t.rowId !== undefined" class="text-[10px] uppercase tracking-wide text-gray-500 dark:text-gray-400">#{{ t.rowId }}</span>
              <span>{{ t.service || 'Trip' }}</span>
              <span *ngIf="t.number">· #{{ t.number }}</span>
            </div>
            <div class="text-gray-800 dark:text-gray-200 flex items-center gap-2" *ngIf="t.total !== undefined">
              <span>${{ t.total | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="text-xs text-gray-600 dark:text-gray-300 flex items-center gap-1" *ngIf="t.pickupTime || t.dropoffTime">
            <mat-icon fontSet="material-icons" class="text-gray-500 dark:text-gray-400" style="font-size:14px">schedule</mat-icon>
            {{ t.pickupTime || '—' }} → {{ t.dropoffTime || '—' }}
            <span *ngIf="t.duration">({{ t.duration }})</span>
          </div>
          <div class="text-[11px] text-gray-600 dark:text-gray-300 flex flex-wrap gap-3">
            <span *ngIf="t.startAddress || t.endAddress" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">route</mat-icon>
              <span>{{ t.startAddress || '—' }}</span>
              <span *ngIf="t.endAddress">→ {{ t.endAddress }}</span>
            </span>
            <span *ngIf="t.distance" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">travel_explore</mat-icon>{{ t.distance | number:'1.1-1' }} mi
            </span>
            <span *ngIf="t.pay" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">payments</mat-icon>${{ t.pay | number:'1.2-2' }} pay
            </span>
            <span *ngIf="t.tip" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">emoji_events</mat-icon>${{ t.tip | number:'1.2-2' }} tip
            </span>
            <span *ngIf="t.bonus" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">star</mat-icon>${{ t.bonus | number:'1.2-2' }} bonus
            </span>
            <span *ngIf="t.cash" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">attach_money</mat-icon>${{ t.cash | number:'1.2-2' }} cash
            </span>
            <span *ngIf="t.amountPerDistance" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">straighten</mat-icon>${{ t.amountPerDistance | number:'1.2-2' }}/mi
            </span>
            <span *ngIf="t.amountPerTime" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">timelapse</mat-icon>${{ t.amountPerTime | number:'1.2-2' }}/hr
            </span>
            <span *ngIf="t.region" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">place</mat-icon>{{ t.region }}
            </span>
            <span *ngIf="t.orderNumber" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">confirmation_number</mat-icon>{{ t.orderNumber }}
            </span>
            <span *ngIf="t.type" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">category</mat-icon>{{ t.type }}
            </span>
            <span *ngIf="t.note" class="flex items-center gap-1">
              <mat-icon fontSet="material-icons" style="font-size:14px" class="text-gray-400 dark:text-gray-500">notes</mat-icon>{{ t.note }}
            </span>
            <span *ngIf="t.key" class="flex items-center gap-1 text-gray-400 dark:text-gray-500">#{{ t.key }}</span>
          </div>
        </div>
      </div>
      <ng-template #noTrips>
        <div class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-700" *ngIf="isShowTrips(s.id)">No trips</div>
      </ng-template>
    </div>

    <div *ngIf="isExpanded(s.id)" class="mt-3">
      <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 dark:text-gray-300">
        <div *ngIf="s.region">Region: {{ s.region }}</div>
        <div *ngIf="s.date">Date: {{ s.date }}</div>
        <div *ngIf="s.service">Service: {{ s.service }}</div>
        <div *ngIf="s.number !== undefined">Shift #: {{ s.number }}</div>
        <div *ngIf="s.key">Key: {{ s.key }}</div>
        <div *ngIf="s.note">Notes: {{ s.note }}</div>
        <div *ngIf="s.total">Total: ${{ s.total | number:'1.2-2' }}</div>
        <div *ngIf="s.tip">Tip: ${{ s.tip | number:'1.2-2' }}</div>
        <div *ngIf="s.distance">Distance: {{ s.distance | number:'1.1-1' }} mi</div>
        <div *ngIf="s.start">Start: {{ s.start }}</div>
        <div *ngIf="s.finish">Finish: {{ s.finish }}</div>
        <div *ngIf="s.active">Active: {{ s.active }}</div>
        <div *ngIf="s.time">Time: {{ s.time }}</div>
        <div *ngIf="s.totalTrips">Total Trips: {{ s.totalTrips }}</div>
        <div *ngIf="s.totalDistance">Total Distance: {{ s.totalDistance | number:'1.0-1' }} mi</div>
        <div *ngIf="s.totalPay">Total Pay: ${{ s.totalPay | number:'1.2-2' }}</div>
        <div *ngIf="s.totalTips">Total Tips: ${{ s.totalTips | number:'1.2-2' }}</div>
        <div *ngIf="s.totalBonus">Total Bonus: ${{ s.totalBonus | number:'1.2-2' }}</div>
        <div *ngIf="s.totalCash">Total Cash: ${{ s.totalCash | number:'1.2-2' }}</div>
        <div *ngIf="s.grandTotal">Grand Total: ${{ s.grandTotal | number:'1.2-2' }}</div>
        <div *ngIf="s.amountPerTrip">$/Trip: ${{ s.amountPerTrip | number:'1.2-2' }}</div>
        <div *ngIf="s.amountPerDistance">$/Mi: ${{ s.amountPerDistance | number:'1.2-2' }}</div>
        <div *ngIf="s.amountPerTime">$/Hr: ${{ s.amountPerTime | number:'1.2-2' }}</div>
      </div>
    </div>

    <div *ngIf="tripAggregates[s.key] && counts[s.key]" class="mt-2 text-[11px] text-gray-600 dark:text-gray-300 border-t border-gray-200 dark:border-gray-600 pt-2 flex flex-wrap gap-x-6 gap-y-1">
      <span class="font-medium">Summary</span>
      <span *ngIf="counts[s.key]">Trips: {{ counts[s.key] }}</span>
      <span *ngIf="tripAggregates[s.key].distance">Distance: {{ tripAggregates[s.key].distance | number:'1.0-1' }}</span>
      <span *ngIf="tripAggregates[s.key].pay">Pay: ${{ tripAggregates[s.key].pay | number:'1.2-2' }}</span>
      <span *ngIf="tripAggregates[s.key].tip">Tip: ${{ tripAggregates[s.key].tip | number:'1.2-2' }}</span>
      <span *ngIf="tripAggregates[s.key].bonus">Bonus: ${{ tripAggregates[s.key].bonus | number:'1.2-2' }}</span>
      <span *ngIf="tripAggregates[s.key].cash">Cash: ${{ tripAggregates[s.key].cash | number:'1.2-2' }}</span>
      <span *ngIf="tripAggregates[s.key].total">Total: ${{ tripAggregates[s.key].total | number:'1.2-2' }}</span>
    </div>
  </div>
</div>
