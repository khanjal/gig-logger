<!-- Mobile-First Trip Quick View Component -->
<div class="trip-card" [ngClass]="{
  'trip-card--excluded': trip.exclude,
  'trip-card--unsaved': !trip.saved,
  'trip-card--add': !trip.saved && trip.action === 'ADD',
  'trip-card--edit': !trip.saved && trip.action === 'UPDATE',
  'trip-card--delete': !trip.saved && trip.action === 'DELETE'
}">
  <!-- Trip Header -->
  <div class="trip-header">
    <!-- Primary header row: ID + Status, Date, Service -->
    <div class="trip-header__primary">
      <div class="trip-header__left">
        <mat-icon class="status-icon"
          [ngClass]="{
            'status-icon--add': !trip.saved && trip.action === 'ADD',
            'status-icon--edit': !trip.saved && trip.action === 'UPDATE',
            'status-icon--delete': !trip.saved && trip.action === 'DELETE',
            'status-icon--saved': trip.saved
          }">
          @if (!trip.saved && trip.action === 'ADD') { add }
          @else if (!trip.saved && trip.action === 'UPDATE') { edit }
          @else if (!trip.saved && trip.action === 'DELETE') { delete }
          @else { check_circle }
        </mat-icon>
        <span class="trip-id">#{{trip.rowId}}</span>
      </div>
      
      <div class="trip-header__center">
        <span class="trip-date">{{trip.date | date:'MMM d'}}</span>
      </div>
      
      <div class="trip-header__right">
        <span class="service-name" [class.service-name--solo]="!trip.number || trip.number <= 0">{{trip.service}}</span>
        <span class="service-number" *ngIf="trip.number > 0">#{{trip.number}}</span>
      </div>
    </div>
    
    <!-- Secondary header row: Time, Distance, Total + Efficiency -->
    <div class="trip-header__secondary">
      <div class="trip-time-section">
        <div class="pickup-time" 
             [ngClass]="{'time-24hr': prefers24Hour, 'time-12hr': !prefers24Hour}"
             [class.pickup-time--placeholder]="!trip.pickupTime">
          {{ trip.pickupTime ? (trip.pickupTime | noseconds:prefers24Hour) : '--:--' }}
        </div>
        <div class="trip-distance" 
             [class.trip-distance--placeholder]="!trip.distance">
          {{distanceDisplay}}
        </div>
      </div>
      
      <div class="trip-earnings-section">
        <div class="total-amount" 
             [class.total-amount--placeholder]="!(trip.pay || trip.tip || trip.bonus || trip.cash)"
             [ngClass]="{
               'earnings--excellent': trip.amountPerTime > 30,
               'earnings--good': trip.amountPerTime >= 25 && trip.amountPerTime <= 30,
               'earnings--average': trip.amountPerTime >= 20 && trip.amountPerTime < 25,
               'earnings--poor': trip.amountPerTime < 20
             }">
          {{(trip.pay || trip.tip || trip.bonus || trip.cash) ? ((trip.pay + trip.tip + trip.bonus + trip.cash) | currency) : '$0.00'}}
        </div>
        <div class="efficiency-rate" 
             [class.efficiency-rate--placeholder]="!trip.amountPerTime">
          ${{trip.amountPerTime ? (trip.amountPerTime | number:'1.0-2') : '0.00'}}/hr
        </div>
      </div>
    </div>
    
    <!-- Place/Name information row - More prominent -->
    <div class="trip-header__place" *ngIf="trip.place || trip.name">
      <div class="place-route">
        <mat-icon class="place-route__icon">place</mat-icon>
        <div class="place-route__text">
          <span class="place-route__from" *ngIf="trip.place" [title]="trip.place">{{trip.place}}</span>
          <mat-icon class="place-route__arrow" *ngIf="trip.place && trip.name">arrow_forward</mat-icon>
          <span class="place-route__to" *ngIf="trip.name" [title]="trip.name">{{trip.name}}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Expandable Toggle Bar -->
  <div class="expand-toggle-bar" 
       (click)="toggleExpansion()" 
       [attr.aria-label]="isExpanded ? 'Collapse trip details' : 'Expand trip details'"
       role="button"
       tabindex="0"
       (keydown.enter)="toggleExpansion()"
       (keydown.space)="toggleExpansion()">
    <div class="expand-toggle-bar__content">
      <div class="expand-toggle-bar__line"></div>
      <div class="expand-toggle-bar__text">
        <span>{{isExpanded ? 'Hide Details' : 'Show Details'}}</span>
        <mat-icon class="expand-toggle-bar__icon">{{isExpanded ? 'expand_less' : 'expand_more'}}</mat-icon>
      </div>
      <div class="expand-toggle-bar__line"></div>
    </div>
  </div>
  
  <!-- Trip Content - Only show when expanded -->
  <div class="trip-content" *ngIf="isExpanded">
    
    <!-- Time Card -->
    <div class="info-card">
      <div class="info-card__header">
        <mat-icon class="info-icon">schedule</mat-icon>
        <h4>{{ trip.type === "" ? "Time" : trip.type }}</h4>
      </div>
      <div class="info-card__content">
        <div class="time-display">
          <span class="pickup-time">
            {{trip.pickupTime | noseconds:prefers24Hour}}
          </span>
          <span class="time-separator" *ngIf="trip.duration && trip.dropoffTime">-</span>
          <span class="dropoff-time" *ngIf="trip.dropoffTime">
            {{trip.dropoffTime | noseconds:prefers24Hour}}
          </span>
        </div>
        <div class="duration" *ngIf="trip.duration">
          <strong>Duration:</strong> {{trip.duration | noseconds:prefers24Hour}}
        </div>
      </div>
    </div>

    <!-- Location Card -->
    <div class="info-card" *ngIf="trip.region || trip.distance">
      <div class="info-card__header">
        <mat-icon class="info-icon">map</mat-icon>
        <h4>Location</h4>
      </div>
      <div class="info-card__content">
        <div class="region" *ngIf="trip.region">{{trip.region}}</div>
        <div class="distance-info" *ngIf="trip.startOdometer || trip.distance">
          <div class="odometer-range" *ngIf="trip.startOdometer">
            <strong>Odometer:</strong> 
            {{trip.startOdometer | number}}
            <span *ngIf="trip.endOdometer"> - {{trip.endOdometer | number}}</span>
          </div>
          <div class="distance-display" *ngIf="trip.distance">
            <strong>Distance:</strong> 
            <span class="distance-value" [ngClass]="{
              'distance--excellent': trip.amountPerDistance > 5,
              'distance--good': trip.amountPerDistance >= 2 && trip.amountPerDistance <= 5,
              'distance--average': trip.amountPerDistance >= 1 && trip.amountPerDistance < 2,
              'distance--poor': trip.amountPerDistance < 1
            }">
              {{convertDistance(trip.distance).toFixed(1)}} {{distanceUnit}}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Pickup Card -->
    <div class="info-card" *ngIf="trip.place || trip.startAddress">
      <div class="info-card__header">
        <mat-icon class="info-icon">storefront</mat-icon>
        <h4>Pickup</h4>
      </div>
      <div class="info-card__content">
        <div class="place-name" *ngIf="trip.place">
          <strong>{{trip.place}}</strong>
        </div>
        <div class="address-link" *ngIf="trip.startAddress">
          <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.startAddress" 
             target="_blank" 
             class="address-link__text">
            {{ trip.startAddress | shortaddress:trip.place | truncate:40}}
            <mat-icon class="external-link-icon">open_in_new</mat-icon>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Dropoff Card -->
    <div class="info-card" *ngIf="trip.name || trip.endAddress">
      <div class="info-card__header">
        <mat-icon class="info-icon">home</mat-icon>
        <h4>Dropoff</h4>
      </div>
      <div class="info-card__content">
        <div class="customer-name" *ngIf="trip.name">
          <strong>{{trip.name | truncate:30}}</strong>
        </div>
        <div class="address-link" *ngIf="trip.endAddress">
          <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.endAddress" 
             target="_blank" 
             class="address-link__text">
            {{ trip.endAddress | shortaddress | truncate:40}}
            <mat-icon class="external-link-icon">open_in_new</mat-icon>
          </a>
        </div>
      </div>
    </div>
      <!-- Payment Card -->
    <div class="info-card" *ngIf="trip.pay || trip.total">
      <div class="info-card__header">
        <mat-icon class="info-icon">payments</mat-icon>
        <h4>Payment</h4>
      </div>
      <div class="info-card__content">
        <div class="payment-grid">
          <!-- First row: Pay, Tip, Bonus -->
          <div class="payment-row payment-row--primary">
            <div class="payment-item" *ngIf="trip.pay">
              <span class="payment-label">Pay</span>
              <span class="payment-value payment-value--pay">{{trip.pay | currency}}</span>
            </div>
            <div class="payment-item" *ngIf="trip.tip">
              <span class="payment-label">Tip</span>
              <span class="payment-value payment-value--tip">{{trip.tip | currency}}</span>
            </div>
            <div class="payment-item" *ngIf="trip.bonus">
              <span class="payment-label">Bonus</span>
              <span class="payment-value payment-value--bonus">{{trip.bonus | currency}}</span>
            </div>
          </div>

          <!-- Second row: Total, Cash, and Efficiency -->
          <div class="payment-row payment-row--secondary">
            <div class="payment-item payment-item--total" *ngIf="trip.total > trip.pay">
              <span class="payment-label">Total</span>
              <span class="payment-value payment-value--total">{{trip.total | currency}}</span>
            </div>
            <div class="payment-item payment-item--cash" *ngIf="trip.cash">
              <span class="payment-label">Cash</span>
              <span class="payment-value payment-value--cash">{{trip.cash | currency}}</span>
            </div>
            <div class="payment-item payment-item--efficiency" *ngIf="trip.amountPerTime">
              <span class="payment-label">Efficiency</span>
              <span class="payment-value payment-value--efficiency" [ngClass]="{
                'efficiency--excellent': trip.amountPerTime > 30,
                'efficiency--good': trip.amountPerTime >= 25 && trip.amountPerTime <= 30,
                'efficiency--average': trip.amountPerTime >= 20 && trip.amountPerTime < 25,
                'efficiency--poor': trip.amountPerTime < 20
              }">
                ${{trip.amountPerTime | number:'1.0-2'}}/hr
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Details Card -->
    <div class="info-card" *ngIf="trip.endUnit || trip.orderNumber || trip.note">
      <div class="info-card__header">
        <mat-icon class="info-icon">description</mat-icon>
        <h4>Details</h4>
      </div>
      <div class="info-card__content">
        <div class="details-grid">
          <div class="detail-item detail-item--unit" *ngIf="trip.endUnit">
            <span class="detail-label">Unit #</span>
            <span class="detail-value">{{trip.endUnit}}</span>
          </div>
          <div class="detail-item detail-item--order" *ngIf="trip.orderNumber">
            <span class="detail-label">Order #</span>
            <span class="detail-value">{{trip.orderNumber}}</span>
          </div>
        </div>
        <div class="trip-note" *ngIf="trip.note">
          <mat-icon class="note-icon">format_quote</mat-icon>
          <span class="note-text">{{trip.note}}</span>
        </div>
      </div>
    </div>
  </div>
  <!-- Action Bar - Always visible, outside collapse -->
  <div class="action-bar" *ngIf="showActions">
    <!-- Edit button on the left -->
    <button mat-fab extended color="primary" class="action-button action-button--primary" (click)="openTripDialog()">
      <mat-icon>edit</mat-icon>
      <span>Edit Trip</span>
    </button>
    
    <!-- Pickup/Dropoff buttons in the middle -->
    <div class="action-bar__center">
      <button mat-fab extended 
              color="accent" 
              class="action-button action-button--accent" 
              (click)="setPickupTime()" 
              *ngIf="!trip.pickupTime && !trip.dropoffTime && !trip.exclude">
        <mat-icon>update</mat-icon>
        <span>Pickup</span>
      </button>
      
      <button mat-fab extended 
              color="accent" 
              class="action-button action-button--accent" 
              (click)="setDropoffTime()" 
              *ngIf="trip.pickupTime && !trip.dropoffTime && !trip.exclude">
        <mat-icon>schedule</mat-icon>
        <span>Dropoff</span>
      </button>
    </div>
    
    <!-- Menu button on the right -->
    <button mat-fab 
            class="action-button action-button--menu" 
            [matMenuTriggerFor]="menu" 
            aria-label="Trip options menu">
      <mat-icon>more_vert</mat-icon>
    </button>
    
    <mat-menu #menu="matMenu" class="trip-menu">
      <button mat-menu-item (click)="nextStopTrip()" class="menu-item">
        <mat-icon>pin_drop</mat-icon>
        <span>Next Stop</span>
      </button>
      <button mat-menu-item (click)="cloneUnsavedTrip()" class="menu-item">
        <mat-icon>content_copy</mat-icon>
        <span>Clone Trip</span>
      </button>
      @if (trip.action != actionEnum.Delete) {
        <button mat-menu-item (click)="confirmDeleteTripDialog()" class="menu-item menu-item--danger">
          <mat-icon>delete</mat-icon>
          <span>Delete Trip</span>
        </button>
      }
      @else {
        <button mat-menu-item (click)="restoreTrip()" class="menu-item menu-item--restore">
          <mat-icon>restore</mat-icon>
          <span>Restore Trip</span>
        </button>
      }
    </mat-menu>
  </div>
  
</div>
