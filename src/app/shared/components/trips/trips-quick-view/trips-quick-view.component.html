<!-- Ultra-Compact Trip Quick View -->
<div class="trip-card ultra-compact" [ngClass]="{
  'trip-card--excluded': trip.exclude,
  'trip-card--unsaved': !trip.saved,
  'trip-card--add': !trip.saved && trip.action === 'ADD',
  'trip-card--edit': !trip.saved && trip.action === 'UPDATE',
  'trip-card--delete': !trip.saved && trip.action === 'DELETE',
  'trip-card--even': index % 2 === 0,
  'trip-card--odd': index % 2 === 1
}">
  <!-- Essential Info Header - Optimized Two-Row -->
  <div class="trip-header ultra-header" [ngClass]="{
    'header--even': index % 2 === 0,
    'header--odd': index % 2 === 1
  }">
    <!-- Primary Row: Status, ID, Service, Time, Amount -->
    <div class="header-primary">
      <div class="status-cell">
        <mat-icon class="status-icon"
          [ngClass]="{
            'status-icon--add': !trip.saved && trip.action === 'ADD',
            'status-icon--edit': !trip.saved && trip.action === 'UPDATE',
            'status-icon--delete': !trip.saved && trip.action === 'DELETE',
            'status-icon--saved': trip.saved
          }">
          @if (!trip.saved && trip.action === 'ADD') { add }
          @else if (!trip.saved && trip.action === 'UPDATE') { edit }
          @else if (!trip.saved && trip.action === 'DELETE') { delete }
          @else { check_circle }
        </mat-icon>
      </div>
      
      <div class="id-cell">
        <span class="trip-id">#{{trip.rowId}}</span>
      </div>
      
      <div class="service-cell">
        <span class="service">{{trip.service}}</span>
        <span class="number" *ngIf="trip.number > 0">#{{trip.number}}</span>
      </div>
      
      <div class="time-cell">
        <span class="time" 
              [ngClass]="{'time-24hr': prefers24Hour, 'time-12hr': !prefers24Hour}"
              [class.placeholder]="!trip.pickupTime">
          {{ trip.pickupTime ? (trip.pickupTime | noseconds:prefers24Hour) : '--:--' }}
        </span>
      </div>
      
      <div class="amount-cell">
        <span class="amount" 
              [class.placeholder]="!(trip.pay || trip.tip || trip.bonus || trip.cash)"
              [ngClass]="{
                'earnings--excellent': trip.amountPerTime > 30,
                'earnings--good': trip.amountPerTime >= 25 && trip.amountPerTime <= 30,
                'earnings--average': trip.amountPerTime >= 20 && trip.amountPerTime < 25,
                'earnings--poor': trip.amountPerTime < 20
              }">
          {{(trip.pay || trip.tip || trip.bonus || trip.cash) ? ((trip.pay + trip.tip + trip.bonus + trip.cash) | currency) : '$0.00'}}
        </span>
      </div>
    </div>
    
    <!-- Secondary Row: Place/Name and Toggle -->
    <div class="header-secondary" *ngIf="trip.place || trip.name">
      <div class="place-cell">
        <span class="place-name">
          <span *ngIf="trip.place">{{trip.place | truncate:20}}</span>
          <span *ngIf="trip.place && trip.name"> â†’ </span>
          <span *ngIf="trip.name">{{trip.name | truncate:20}}</span>
        </span>
      </div>
      
      <div class="toggle-cell">
        <button class="toggle-btn" 
                (click)="toggleExpansion()"
                [attr.aria-label]="isExpanded ? 'Hide details' : 'Show details'"
                [title]="isExpanded ? 'Hide details' : 'Show details'">
          <mat-icon>{{isExpanded ? 'expand_less' : 'expand_more'}}</mat-icon>
          <span class="toggle-label">{{isExpanded ? 'Less' : 'More'}}</span>
        </button>
      </div>
    </div>
    
    <!-- Toggle only row when no place/name -->
    <div class="header-secondary" *ngIf="!trip.place && !trip.name">
      <div></div> <!-- Empty spacer -->
      <div class="toggle-cell">
        <button class="toggle-btn" 
                (click)="toggleExpansion()"
                [attr.aria-label]="isExpanded ? 'Hide details' : 'Show details'"
                [title]="isExpanded ? 'Hide details' : 'Show details'">
          <mat-icon>{{isExpanded ? 'expand_less' : 'expand_more'}}</mat-icon>
          <span class="toggle-label">{{isExpanded ? 'Less' : 'More'}}</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Compact Details Grid - Only when expanded -->
  <div class="trip-details ultra-details" *ngIf="isExpanded">
    <div class="details-grid">
      <!-- Time & Duration -->
      <div class="detail-group time-group" *ngIf="trip.dropoffTime || trip.duration">
        <div class="group-header">
          <mat-icon>schedule</mat-icon>
          <span>Time</span>
        </div>
        <div class="group-items multi-column">
          <div class="item" *ngIf="trip.dropoffTime">
            <span class="label">Drop</span>
            <span class="value">{{trip.dropoffTime | noseconds:prefers24Hour}}</span>
          </div>
          <div class="item" *ngIf="trip.duration">
            <span class="label">Duration</span>
            <span class="value">{{trip.duration | noseconds:prefers24Hour}}</span>
          </div>
        </div>
      </div>
      
      <!-- Addresses -->
      <div class="detail-group address-group" *ngIf="trip.startAddress || trip.endAddress">
        <div class="group-header">
          <mat-icon>place</mat-icon>
          <span>Addresses</span>
        </div>
        <div class="group-items">
          <div class="item address-item" *ngIf="trip.startAddress">
            <span class="label">From</span>
            <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.startAddress" 
               target="_blank" class="value link">
              {{ trip.startAddress | shortaddress:trip.place | truncate:25}}
              <mat-icon class="link-icon">open_in_new</mat-icon>
            </a>
          </div>
          <div class="item address-item" *ngIf="trip.endAddress">
            <span class="label">To</span>
            <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.endAddress" 
               target="_blank" class="value link">
              {{ trip.endAddress | shortaddress | truncate:25}}
              <mat-icon class="link-icon">open_in_new</mat-icon>
            </a>
          </div>
        </div>
      </div>
      
      <!-- Payment Details -->
      <div class="detail-group payment-group" *ngIf="trip.pay || trip.tip || trip.bonus || trip.cash || trip.total">
        <div class="group-header">
          <mat-icon>payments</mat-icon>
          <span>Payment</span>
        </div>
        <div class="group-items multi-column">
          <div class="item" *ngIf="trip.pay">
            <span class="label">Pay</span>
            <span class="value">{{trip.pay | currency}}</span>
          </div>
          <div class="item" *ngIf="trip.tip">
            <span class="label">Tip</span>
            <span class="value">{{trip.tip | currency}}</span>
          </div>
          <div class="item" *ngIf="trip.bonus">
            <span class="label">Bonus</span>
            <span class="value">{{trip.bonus | currency}}</span>
          </div>
          <div class="item" *ngIf="trip.cash">
            <span class="label">Cash</span>
            <span class="value">{{trip.cash | currency}}</span>
          </div>
          <div class="item total-item" *ngIf="trip.total">
            <span class="label">Total</span>
            <span class="value total-amount">{{trip.total | currency}}</span>
          </div>
        </div>
      </div>
      
      <!-- Trip Info as Card Grid -->
      <div class="detail-group info-group card-grid" *ngIf="trip.distance || trip.region || trip.type || trip.endUnit || trip.orderNumber || trip.startOdometer || trip.endOdometer || trip.amountPerDistance">
        <div class="group-header">
          <mat-icon>info</mat-icon>
          <span>Details</span>
        </div>
        <div class="info-card-grid">
          <div class="info-card" *ngIf="trip.distance">
            <mat-icon class="info-icon">straighten</mat-icon>
            <span class="label">Distance</span>
            <span class="value">{{trip.distance | number:'1.1'}} mi</span>
          </div>
          <div class="info-card" *ngIf="trip.amountPerTime">
            <mat-icon class="info-icon">speed</mat-icon>
            <span class="label">Rate/Hour</span>
            <span class="value">${{trip.amountPerTime | number:'1.0'}}/hr</span>
          </div>
          <div class="info-card" *ngIf="trip.amountPerDistance">
            <mat-icon class="info-icon">local_gas_station</mat-icon>
            <span class="label">Rate/Mile</span>
            <span class="value">${{trip.amountPerDistance | number:'1.2'}}/mi</span>
          </div>
          <div class="info-card" *ngIf="trip.region">
            <mat-icon class="info-icon">map</mat-icon>
            <span class="label">Region</span>
            <span class="value">{{trip.region}}</span>
          </div>
          <div class="info-card" *ngIf="trip.type && trip.type !== ''">
            <mat-icon class="info-icon">category</mat-icon>
            <span class="label">Type</span>
            <span class="value">{{trip.type}}</span>
          </div>
          <div class="info-card" *ngIf="trip.endUnit">
            <mat-icon class="info-icon">precision_manufacturing</mat-icon>
            <span class="label">Unit</span>
            <span class="value">{{trip.endUnit}}</span>
          </div>
          <div class="info-card" *ngIf="trip.orderNumber">
            <mat-icon class="info-icon">confirmation_number</mat-icon>
            <span class="label">Order</span>
            <span class="value">{{trip.orderNumber}}</span>
          </div>
          <div class="info-card" *ngIf="trip.startOdometer">
            <mat-icon class="info-icon">trip_origin</mat-icon>
            <span class="label">Start ODO</span>
            <span class="value">{{trip.startOdometer | number:'1.0'}} mi</span>
          </div>
          <div class="info-card" *ngIf="trip.endOdometer">
            <mat-icon class="info-icon">flag</mat-icon>
            <span class="label">End ODO</span>
            <span class="value">{{trip.endOdometer | number:'1.0'}} mi</span>
          </div>
        </div>
      </div>
      
      <!-- Note (Full Width) -->
      <div class="detail-group note-group" *ngIf="trip.note">
        <div class="group-header">
          <mat-icon>format_quote</mat-icon>
          <span>Note</span>
        </div>
        <div class="group-items">
          <div class="item note-item">
            <span class="value">{{trip.note}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Micro Action Bar -->
  <div class="action-bar micro-actions" *ngIf="showActions">
    <div class="action-group left-group">
      <button mat-button class="action-btn edit-btn" (click)="openTripDialog()" title="Edit Trip">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>
    </div>
    <div class="action-group center-group">
      <button mat-button class="action-btn pickup-btn" (click)="setPickupTime()"
              *ngIf="!trip.pickupTime && !trip.dropoffTime && !trip.exclude"
              title="Set Pickup Time">
        <mat-icon>update</mat-icon>
        <span>Pickup</span>
      </button>
      <button mat-button class="action-btn dropoff-btn" (click)="setDropoffTime()"
              *ngIf="trip.pickupTime && !trip.dropoffTime && !trip.exclude"
              title="Set Dropoff Time">
        <mat-icon>schedule</mat-icon>
        <span>Dropoff</span>
      </button>
    </div>
    <div class="action-group right-group">
      <button mat-icon-button class="action-btn menu-btn" [matMenuTriggerFor]="menu" title="More options">
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>
    <mat-menu #menu="matMenu" class="trip-menu">
      <button mat-menu-item (click)="nextStopTrip()">
        <mat-icon>pin_drop</mat-icon>
        <span>Next Stop</span>
      </button>
      <button mat-menu-item (click)="cloneUnsavedTrip()">
        <mat-icon>content_copy</mat-icon>
        <span>Clone</span>
      </button>
      @if (trip.action != actionEnum.Delete) {
        <button mat-menu-item (click)="confirmDeleteTripDialog()" class="menu-danger">
          <mat-icon>delete</mat-icon>
          <span>Delete</span>
        </button>
      }
      @else {
        <button mat-menu-item (click)="restoreTrip()">
          <mat-icon>restore</mat-icon>
          <span>Restore</span>
        </button>
      }
    </mat-menu>
  </div>
</div>
