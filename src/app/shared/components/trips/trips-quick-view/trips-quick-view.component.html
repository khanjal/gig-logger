<!-- Enhanced Mobile-First Trip Quick View -->
<div class="bg-white border border-gray-200 rounded-xl mb-4 overflow-hidden shadow transition-shadow shadow-sm hover:shadow-md"
  [ngClass]="{
    'opacity-60 bg-gray-50': trip.exclude,
    'border-l-8 border-l-orange-400': !trip.saved,
    'border-l-8 border-l-green-500': !trip.saved && trip.action === 'ADD',
    'border-l-8 border-l-blue-500': !trip.saved && trip.action === 'UPDATE',
    'border-l-8 border-l-red-500': !trip.saved && trip.action === 'DELETE',
    'bg-gradient-to-r from-blue-50 to-white': index % 2 === 0 && !trip.exclude,
    'bg-gradient-to-r from-green-50 to-white': index % 2 === 1 && !trip.exclude
  }">
  <!-- Simplified Mobile-First Header -->
  <div class="p-3 border-b"
    [ngClass]="{
      'bg-blue-50 border-blue-200': index % 2 === 0,
      'bg-green-50 border-green-200': index % 2 === 1
    }">
    <!-- Single-Line Header Row -->
    <div class="flex items-center gap-2 sm:gap-4 min-w-0 w-full overflow-x-auto">
      <!-- Status Icon -->
      <mat-icon class="text-xl flex-shrink-0"
        [ngClass]="{
          'text-green-500': trip.saved,
          'text-blue-500': !trip.saved && trip.action === 'ADD',
          'text-yellow-500': !trip.saved && trip.action === 'UPDATE',
          'text-red-500': !trip.saved && trip.action === 'DELETE'
        }">
        @if (!trip.saved && trip.action === 'ADD') { add }
        @else if (!trip.saved && trip.action === 'UPDATE') { edit }
        @else if (!trip.saved && trip.action === 'DELETE') { delete }
        @else { check_circle }
      </mat-icon>
      <!-- Row ID -->
      <span class="text-xs font-bold text-gray-700 font-mono flex-shrink-0">#{{trip.rowId}}</span>
      <!-- Service Name -->
      <span class="font-bold text-gray-900 truncate text-sm sm:text-base flex-shrink min-w-0">{{trip.service}}</span>
      <!-- Trip Number -->
      <span class="text-xs text-gray-500 font-mono flex-shrink-0" *ngIf="trip.number > 0">#{{trip.number}}</span>
      <!-- Time -->
      <span class="flex items-center gap-1 flex-shrink-0">
        <mat-icon class="text-blue-400 text-base">schedule</mat-icon>
        <span class="font-mono text-sm font-medium"
              [ngClass]="{
                'text-gray-400': !trip.pickupTime,
                'text-gray-700': trip.pickupTime
              }">
          {{ trip.pickupTime ? (trip.pickupTime | noseconds:prefers24Hour) : '--:--' }}
        </span>
      </span>
      <!-- Spacer -->
      <span class="flex-1"></span>
      <!-- Total (far right) -->
      <span class="flex items-center gap-1 flex-shrink-0">
        <mat-icon class="text-green-400 text-base">payments</mat-icon>
        <span class="font-bold text-sm sm:text-base"
              [ngClass]="{
                'text-gray-400': !(trip.pay || trip.tip || trip.bonus || trip.cash),
                'text-green-600': trip.amountPerTime > 30,
                'text-blue-600': trip.amountPerTime >= 25 && trip.amountPerTime <= 30,
                'text-yellow-600': trip.amountPerTime >= 20 && trip.amountPerTime < 25,
                'text-red-500': trip.amountPerTime < 20
              }">
          {{(trip.pay || trip.tip || trip.bonus || trip.cash) ? ((trip.pay + trip.tip + trip.bonus + trip.cash) | currency) : '$0.00'}}
        </span>
      </span>
    </div>
    <!-- Place -> Name Row (always visible if present) -->
    <div class="mt-1 text-xs text-gray-600 truncate text-center" *ngIf="trip.place || trip.name">
      <span *ngIf="trip.place">{{trip.place | truncate:40}}</span>
      <span *ngIf="trip.place && trip.name"> â†’ </span>
      <span *ngIf="trip.name">{{trip.name | truncate:40}}</span>
    </div>
    <!-- Toggle Button -->
    <div
         [ngClass]="{
           'bg-blue-50 rounded-b-md': index % 2 === 0,
           'bg-green-50 rounded-b-md': index % 2 === 1
         }"
         class="focus-within:ring-0 focus-within:outline-none"
         *ngIf="trip.dropoffTime || trip.duration || trip.distance || trip.amountPerTime || trip.pay || trip.tip || trip.bonus || trip.cash || trip.total || trip.startAddress || trip.endAddress || (trip.type && trip.type !== '') || trip.orderNumber || trip.endUnit || trip.startOdometer || trip.endOdometer || trip.note">
      <button class="w-full flex items-center justify-center gap-2 py-1 text-xs text-gray-400 hover:text-blue-500 transition-colors bg-transparent font-medium outline-none ring-0 focus:outline-none focus:ring-0 border-0 shadow-none"
              (click)="toggleExpansion()" 
              tabindex="0" 
              [attr.aria-label]="isExpanded ? 'Hide details' : 'Show details'"
              [title]="isExpanded ? 'Hide details' : 'Show details'"
              (keydown.enter)="toggleExpansion()" 
              (keydown.space)="toggleExpansion()">
        <span class="flex-1 h-px bg-gray-200"></span>
        <mat-icon class="text-base">{{isExpanded ? 'expand_less' : 'expand_more'}}</mat-icon>
        <span class="font-normal">{{isExpanded ? 'Less' : 'More'}} Details</span>
        <span class="flex-1 h-px bg-gray-200"></span>
      </button>
    </div>
  </div>
  <!-- Simplified Details Section -->
  <div class="p-3 bg-gray-50 border-t" *ngIf="isExpanded">
    <!-- Quick Stats Row -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4" *ngIf="trip.dropoffTime || trip.duration || trip.distance || trip.amountPerTime">
      <div *ngIf="trip.dropoffTime" class="text-center p-2 bg-white rounded-lg border">
        <div class="text-xs text-gray-500 mb-1">Drop Time</div>
        <div class="font-mono text-sm font-bold">{{trip.dropoffTime | noseconds:prefers24Hour}}</div>
      </div>
      <div *ngIf="trip.duration" class="text-center p-2 bg-white rounded-lg border">
        <div class="text-xs text-gray-500 mb-1">Duration</div>
        <div class="font-mono text-sm font-bold">{{trip.duration | noseconds:prefers24Hour}}</div>
      </div>
      <div *ngIf="trip.distance" class="text-center p-2 bg-white rounded-lg border">
        <div class="text-xs text-gray-500 mb-1">Distance</div>
        <div class="text-sm font-bold">{{trip.distance | number:'1.1'}} mi</div>
      </div>
      <div *ngIf="trip.amountPerTime" class="text-center p-2 bg-white rounded-lg border">
        <div class="text-xs text-gray-500 mb-1">Rate/Hr</div>
        <div class="text-sm font-bold text-green-600">${{trip.amountPerTime | number:'1.0'}}</div>
      </div>
    </div>
    <!-- Payment Breakdown -->
    <div class="mb-4" *ngIf="trip.pay || trip.tip || trip.bonus || trip.cash">
      <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
        <mat-icon class="text-orange-500 text-base">payments</mat-icon>
        Payment Details
      </h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
        <div *ngIf="trip.pay" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Pay</span>
          <span class="text-sm font-bold">{{trip.pay | currency}}</span>
        </div>
        <div *ngIf="trip.tip" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Tip</span>
          <span class="text-sm font-bold">{{trip.tip | currency}}</span>
        </div>
        <div *ngIf="trip.bonus" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Bonus</span>
          <span class="text-sm font-bold">{{trip.bonus | currency}}</span>
        </div>
        <div *ngIf="trip.cash" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Cash</span>
          <span class="text-sm font-bold">{{trip.cash | currency}}</span>
        </div>
      </div>
      <div *ngIf="trip.total" class="mt-2 p-2 bg-green-50 rounded border border-green-200">
        <div class="flex justify-between items-center">
          <span class="text-sm font-semibold text-green-700">Total</span>
          <span class="text-lg font-bold text-green-700">{{trip.total | currency}}</span>
        </div>
      </div>
    </div>
    <!-- Addresses -->
    <div class="mb-4" *ngIf="trip.startAddress || trip.endAddress">
      <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
        <mat-icon class="text-green-500 text-base">place</mat-icon>
        Addresses
      </h3>
      <div class="space-y-2">
        <div *ngIf="trip.startAddress" class="p-2 bg-white rounded border">
          <div class="text-xs text-gray-500 mb-1">From</div>
          <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.startAddress" 
             target="_blank" 
             class="text-sm text-blue-600 hover:underline flex items-center gap-1">
            {{ trip.startAddress | shortaddress:trip.place | truncate:50}}
            <mat-icon class="text-xs">open_in_new</mat-icon>
          </a>
        </div>
        <div *ngIf="trip.endAddress" class="p-2 bg-white rounded border">
          <div class="text-xs text-gray-500 mb-1">To</div>
          <a [href]="'https://www.google.com/maps/search/?api=1&query=' + trip.endAddress" 
             target="_blank" 
             class="text-sm text-blue-600 hover:underline flex items-center gap-1">
            {{ trip.endAddress | shortaddress | truncate:50}}
            <mat-icon class="text-xs">open_in_new</mat-icon>
          </a>
        </div>
      </div>
    </div>
    <!-- Additional Info: Only show if more than just region -->
    <div class="mb-4" *ngIf="(trip.type && trip.type !== '') || trip.orderNumber || trip.endUnit || trip.startOdometer || trip.endOdometer">
      <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
        <mat-icon class="text-purple-500 text-base">info</mat-icon>
        Trip Info
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
        <div *ngIf="trip.type && trip.type !== ''" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Type</span>
          <span class="text-sm font-medium">{{trip.type}}</span>
        </div>
        <div *ngIf="trip.orderNumber" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Order #</span>
          <span class="text-sm font-medium">{{trip.orderNumber}}</span>
        </div>
        <div *ngIf="trip.endUnit" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Unit</span>
          <span class="text-sm font-medium">{{trip.endUnit}}</span>
        </div>
        <div *ngIf="trip.startOdometer" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">Start ODO</span>
          <span class="text-sm font-medium">{{trip.startOdometer | number:'1.0'}}</span>
        </div>
        <div *ngIf="trip.endOdometer" class="flex justify-between p-2 bg-white rounded border">
          <span class="text-xs text-gray-600">End ODO</span>
          <span class="text-sm font-medium">{{trip.endOdometer | number:'1.0'}}</span>
        </div>
      </div>
    </div>
    <!-- Note -->
    <div *ngIf="trip.note" class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
      <h3 class="text-sm font-semibold text-yellow-800 mb-2 flex items-center gap-2">
        <mat-icon class="text-yellow-600 text-base">format_quote</mat-icon>
        Note
      </h3>
      <p class="text-sm text-yellow-700 italic">{{trip.note}}</p>
    </div>
  </div>
  <!-- Simplified Action Bar -->
  <div class="flex items-center justify-between p-3 bg-gray-100 border-t">
    <!-- Edit Button -->
    <button mat-button 
            class="flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-sm font-medium hover:bg-blue-100 transition" 
            (click)="openTripDialog()" 
            title="Edit Trip">
      <mat-icon class="text-base">edit</mat-icon>
      <span class="hidden sm:inline">Edit</span>
    </button>
    <!-- Center Action Buttons -->
    <div class="flex gap-2">
      <button mat-button 
              class="flex items-center gap-1 px-3 py-2 bg-green-50 text-green-700 border border-green-200 rounded-lg text-sm font-medium hover:bg-green-100 transition" 
              (click)="setPickupTime()"
              *ngIf="!trip.pickupTime && !trip.dropoffTime && !trip.exclude"
              title="Set Pickup Time">
        <mat-icon class="text-base">schedule</mat-icon>
        <span class="hidden sm:inline">Pickup</span>
      </button>
      <button mat-button 
              class="flex items-center gap-1 px-3 py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded-lg text-sm font-medium hover:bg-orange-100 transition" 
              (click)="setDropoffTime()"
              *ngIf="trip.pickupTime && !trip.dropoffTime && !trip.exclude"
              title="Set Dropoff Time">
        <mat-icon class="text-base">schedule</mat-icon>
        <span class="hidden sm:inline">Dropoff</span>
      </button>
    </div>
    <!-- Menu Button -->
    <button mat-icon-button 
            class="w-10 h-10 bg-gray-200 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-300 transition" 
            [matMenuTriggerFor]="menu" 
            title="More options">
      <mat-icon>more_vert</mat-icon>
    </button>
    <!-- Menu -->
    <mat-menu #menu="matMenu" class="trip-menu">
      <button mat-menu-item (click)="nextStopTrip()">
        <mat-icon>pin_drop</mat-icon>
        <span>Next Stop</span>
      </button>
      <button mat-menu-item (click)="cloneUnsavedTrip()">
        <mat-icon>content_copy</mat-icon>
        <span>Clone</span>
      </button>
      @if (trip.action != actionEnum.Delete) {
        <button mat-menu-item (click)="confirmDeleteTripDialog()" class="text-red-600 hover:bg-red-50"
                title="Delete Trip">
          <mat-icon class="text-red-600">delete</mat-icon>
          <span>Delete</span>
        </button>
      }
      @else {
        <button mat-menu-item (click)="restoreTrip()">
          <mat-icon>restore</mat-icon>
          <span>Restore</span>
        </button>
      }
    </mat-menu>
  </div>
</div>
