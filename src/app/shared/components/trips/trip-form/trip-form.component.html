<div class="bg-white rounded-xl shadow-lg p-4 md:p-8 w-full max-w-2xl mx-auto">
  <div class="mb-1 border-b pb-2">
    <h1 class="text-2xl font-bold text-blue-700">{{title}}</h1>
  </div>

  <form [formGroup]="tripForm">
    <!-- Shift Selection -->
    <div>
      <div class="flex flex-col mb-3">
        <mat-form-field class="w-full" appearance="outline">
          <mat-label>Shift/Batch/Group</mat-label>
          <mat-select #shiftSelect name="shift" formControlName="shift" [(value)]="selectedShift" [compareWith]="compareShifts" (selectionChange)='onShiftSelected(shiftSelect.value)'>
            <mat-option value="">New</mat-option>
            <mat-option *ngFor="let shift of shifts" [value]="shift">{{ shift.date | date:'E MMM d' }} - {{ shift.service | truncate:10 }} {{ shift.number == 0 ? "" : '#' + shift.number }} ({{ shift.totalTrips }} &#64; {{ shift.grandTotal | currency }})</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- New Shift Fields -->
    @if (isNewShift) {
      <div>
        <div class="flex flex-col mb-3">
          <app-search-input 
            class="w-full"
            fieldName="Service" 
            searchType="Service" 
            formControlName="service"
            [isRequired]="true">
          </app-search-input>
        </div>
      </div>
    }

    <div class="flex flex-col gap-1 mb-3">
      <app-search-input 
        class="w-full"
        fieldName="Region/Zone" 
        searchType="Region" 
        formControlName="region">
      </app-search-input>
    </div>
    <!-- Location Information -->
    <div class="mb-3">
      <div class="flex flex-col gap-1 mb-3">
        <app-search-input 
          class="w-full"
          fieldName="Place" 
          searchType="Place" 
          formControlName="place"
          googleSearch="place"
          (valueChanged)="selectPlace()"
          (auxiliaryData)="setPickupAddress($event)">
        </app-search-input>
      </div>
      <div class="flex flex-col gap-1 mb-3">
        <app-search-input 
          class="w-full"
          fieldName="Type" 
          searchType="Type" 
          formControlName="type">
        </app-search-input>
      </div>
    </div>

    <!-- Payment Information -->
    <div>
      <div class="flex items-center gap-1 justify-between w-full mb-3">
        <button 
          mat-mini-fab
          type="button"
          class="toggle-button"
          [class.toggle-button--active]="showAdvancedPay"
          [color]="showAdvancedPay ? 'accent' : 'primary'" 
          aria-label="Toggle Advanced Pay" 
          (click)="toggleAdvancedPay()">
          <mat-icon>account_balance</mat-icon>
        </button>
        <div class="flex flex-1 justify-center gap-1 min-w-0 max-w-full">
          <mat-form-field class="flex-1 min-w-0 ml-2" appearance="outline">
            <mat-label>Pay</mat-label>
            <input matInput type="number" name="pay" placeholder="4.75" formControlName="pay" (wheel)="$event.preventDefault()">
          </mat-form-field>
          <mat-form-field class="flex-1 min-w-0 mr-2" appearance="outline">
            <mat-label>Distance</mat-label>
            <input matInput type="number" name="distance" placeholder="8.04" formControlName="distance" (wheel)="$event.preventDefault()">
          </mat-form-field>
        </div>
        <button 
          mat-mini-fab
          type="button"
          class="toggle-button"
          [class.toggle-button--active]="showOdometer"
          [color]="showOdometer ? 'accent' : 'primary'" 
          aria-label="Toggle Odometer" 
          (click)="toggleOdometer()">
          <mat-icon>drive_eta</mat-icon>
        </button>
      </div>
      <div class="flex gap-1 mb-3" *ngIf="showAdvancedPay">
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Tip</mat-label>
          <input matInput type="number" name="tip" placeholder="3.5" formControlName="tip" (wheel)="$event.preventDefault()">
        </mat-form-field>
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Bonus</mat-label>
          <input matInput type="number" name="bonus" placeholder="2" formControlName="bonus" (wheel)="$event.preventDefault()">
        </mat-form-field>
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Cash</mat-label>
          <input matInput type="number" name="cash" placeholder="5" formControlName="cash" (wheel)="$event.preventDefault()">
        </mat-form-field>
      </div>
      <div class="flex gap-1 mb-3" *ngIf="showOdometer">
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Start Odometer</mat-label>
          <input matInput type="number" name="startOdometer" placeholder="10,000" formControlName="startOdometer" (wheel)="$event.preventDefault()">
        </mat-form-field>
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>End Odometer</mat-label>
          <input matInput type="number" name="endOdometer" placeholder="10,005" formControlName="endOdometer" (wheel)="$event.preventDefault()">
        </mat-form-field>
      </div>
    </div>

    <!-- Customer Information -->
    <div>
      <div class="flex items-center gap-1" [ngClass]="(selectedPlaceAddresses?.length || 0) > 0 ? 'mb-1' : 'mb-3'">
        <app-search-input 
          class="w-full mr-2"
          fieldName="Name" 
          searchType="Name" 
          formControlName="name"
          (valueChanged)="showNameAddresses()"
          (auxiliaryData)="setDropoffAddress($event)">
        </app-search-input>
        <button
          mat-mini-fab
          type="button"
          class="toggle-button"
          [class.toggle-button--active]="showPickupAddress"
          [color]="showPickupAddress ? 'accent' : 'primary'" 
          aria-label="Show Pickup Address" 
          (click)="togglePickupAddress()">
          <mat-icon>contact_mail</mat-icon>
        </button>
      </div>
      <div *ngIf="showPickupAddress && selectedPlace && selectedPlaceAddresses && selectedPlaceAddresses.length > 0" class="mb-3">
        <mat-accordion>
          <mat-expansion-panel class="seamless-panel" [expanded]="!(selectedPlaceAddresses.length > 5 && data.id)">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ selectedPlaceAddresses.length }} Previous Addresses for Place
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="flex flex-col gap-1">
              <button 
                *ngFor="let address of selectedPlaceAddresses"
                type="button"
                mat-stroked-button 
                color="primary" 
                class="address-button"
                [class.address-button--selected]="address.address === tripForm.value.startAddress"
                (click)="setPickupAddress(address.address)">
                {{ address.address | shortaddress:selectedPlace.place | truncate:28 }} ({{ address.trips }})
              </button>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <div class="flex flex-col gap-1" [ngClass]="(selectedNameDeliveries?.length || 0) > 0 ? 'mb-1' : 'mb-3'" *ngIf="showPickupAddress">
        <app-search-input 
          class="w-full"
          fieldName="Pickup Address" 
          searchType="Address" 
          formControlName="startAddress"
          googleSearch="address">
        </app-search-input>
      </div>
    </div>

    <!-- Address List/Notes -->
    <div *ngIf="selectedNameDeliveries?.length" class="mb-3">
      <mat-accordion>
        <mat-expansion-panel class="seamless-panel" [expanded]="selectedNameDeliveries && !(selectedNameDeliveries.length > 5 && data.id)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{ selectedNameDeliveries ? selectedNameDeliveries.length : 0  }} Previous Addresses for Name
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let delivery of selectedNameDeliveries" class="flex flex-col gap-1">
            <div class="text-gray-500 font-medium" *ngIf="!delivery.address">
              Unknown Address ({{delivery.visits}})
            </div>
            <button 
              mat-stroked-button 
              color="primary" 
              class="address-button" 
              [class.address-button--selected]="delivery.address === tripForm.value.endAddress" 
              (click)="setDestinationAddress(delivery.address)" 
              *ngIf="delivery.address">
              {{ delivery.address | shortaddress:'':1 | truncate:45 }} ({{ delivery?.visits }})
            </button>
            <app-trips-table-basic class="trips-table" [trips]="delivery.trips"></app-trips-table-basic>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <!-- Destination Address -->
    <div>
      <div class="flex flex-col gap-1" [ngClass]="(selectedAddressDeliveries?.length || 0) > 0 ? 'mb-1' : 'mb-3'">
        <app-search-input 
          class="w-full"
          fieldName="Destination Address" 
          searchType="Address" 
          formControlName="endAddress"
          googleSearch="address"
          (valueChanged)="showAddressNames()"
        ></app-search-input>
      </div>
    </div>

    <!-- Name List/Notes -->
    <div *ngIf="selectedAddressDeliveries?.length" class="mb-3">
      <mat-accordion>
        <mat-expansion-panel class="seamless-panel" [expanded]="selectedAddressDeliveries && !(selectedAddressDeliveries.length > 5 && data.id)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{ selectedAddressDeliveries ? selectedAddressDeliveries.length : 0  }} Previous Names for Destination
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let delivery of selectedAddressDeliveries" class="flex flex-col gap-1">
            <div class="text-gray-500 font-medium" *ngIf="!delivery.name">
              Unknown Name ({{delivery.visits}})
            </div>
            <button 
              mat-stroked-button 
              color="primary" 
              class="name-button" 
              [class.name-button--selected]="delivery.name === tripForm.value.name" 
              (click)="setName(delivery.name)" 
              *ngIf="delivery.name">
              {{ delivery.name | truncate:45 }} ({{ delivery.visits }})
            </button>
            <app-trips-table-basic class="trips-table" [trips]="delivery.trips"></app-trips-table-basic>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <!-- Time Inputs -->
    <div *ngIf="data?.id">
      <div class="flex gap-1 mb-3">
        <app-time-input 
          label="Pickup Time"
          formControlName="pickupTime"
          class="flex-1 min-w-[90px]"
        >
        </app-time-input>
        <app-time-input 
          label="Dropoff Time"
          formControlName="dropoffTime"
          class="flex-1 min-w-[90px]"
        >
        </app-time-input>
      </div>
    </div>

    <!-- Note and Order -->
    <div>
      <div class="flex items-center gap-1 mb-3">
        <mat-form-field class="w-full mr-2" appearance="outline">
          <mat-label>Note</mat-label>
          <input matInput type="text" name="note" placeholder="" formControlName="note">
        </mat-form-field>
        <button 
          mat-mini-fab
          type="button"
          class="toggle-button"
          [color]="showOrder ? 'accent' : 'primary'" 
          aria-label="Toggle Address/Order" 
          (click)="toggleOrder()">
          <mat-icon>business</mat-icon>
        </button>
      </div>
      <div class="flex gap-1 mb-3" *ngIf="showOrder">
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Apt/Unit/Room</mat-label>
          <input matInput type="text" name="endUnit" placeholder="104" formControlName="endUnit">
        </mat-form-field>
        <mat-form-field class="flex-1 min-w-[90px]" appearance="outline">
          <mat-label>Order Number</mat-label>
          <input matInput type="text" name="orderNumber" placeholder="FC229" formControlName="orderNumber">
        </mat-form-field>
      </div>
      <div *ngIf="showOrder">
        <mat-slide-toggle name="exclude" formControlName="exclude">
          Exclude from calculations
        </mat-slide-toggle>
      </div>
    </div>
  </form>

  <!-- Form Actions -->
  <div class="flex flex-col gap-4 mt-6">
    <div class="flex w-full items-center justify-between">
      <button *ngIf="!data?.id" mat-fab extended color="warn" (click)="formReset()">
        <mat-icon>refresh</mat-icon> Reset
      </button>
      <button *ngIf="data?.id" mat-fab extended color="warn" (click)="close()">
        <mat-icon>cancel</mat-icon> Cancel
      </button>
      <!-- Centered voice input button -->
      <div class="flex-1 flex justify-center">
        <voice-input (voiceResult)="onVoiceResult($event)" #voice></voice-input>
      </div>
      <button *ngIf="!data?.id" mat-fab extended color="primary" (click)="addTrip()" [disabled]="!tripForm.valid" [class.button-disabled]="!tripForm.valid">
        <mat-icon>add</mat-icon> Store
      </button>
      <button *ngIf="data?.id" mat-fab extended color="primary" (click)="editTrip()" [disabled]="!tripForm.valid">
        <mat-icon>save</mat-icon> Update
      </button>
    </div>
  </div>
    <!-- Transcript display below buttons -->
    <div *ngIf="voice.transcript" class="w-full mt-2 text-xs text-gray-600 flex items-center gap-2 px-2">
      <mat-icon>graphic_eq</mat-icon>
      <span class="truncate block w-full">{{ voice.transcript }}</span>
    </div>
</div>