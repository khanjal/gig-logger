<!-- Compact sync status indicator -->
<div class="sync-indicator flex items-center relative max-w-full" [ngClass]="getStatusClass()">
  <ng-template #syncContent>
    <!-- Current status -->
    <div class="p-4 space-y-2 border-b border-[var(--color-border-light)] bg-[var(--color-surface)]">
      <div class="flex items-start justify-between gap-2 text-sm">
        <span class="font-medium text-secondary whitespace-nowrap">Sync Status:</span>
        <span class="font-medium text-right" [ngClass]="getStatusClass()">
          {{ getStatusText() }}
        </span>
      </div>
      
      <div class="flex items-start justify-between gap-2 text-sm" *ngIf="syncState?.status === 'syncing'">
        <span class="font-medium text-secondary whitespace-nowrap">Progress:</span>
        <span class="text-right text-primary">
          {{ syncState?.progress }}%
          <span *ngIf="(syncState?.totalItems || 0) > 0">
            ({{ syncState?.itemsSynced }}/{{ syncState?.totalItems }})
          </span>
        </span>
      </div>

      <div *ngIf="syncState?.status === 'syncing' && (syncState?.progress || 0) > 0">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="syncState?.progress || 0"></div>
        </div>
      </div>

      <div class="flex items-start justify-between gap-2 text-sm">
        <span class="font-medium text-secondary whitespace-nowrap">Last sync:</span>
        <span class="text-right text-primary">{{ timeSinceLastSync }}</span>
      </div>

      <div class="flex items-start justify-between gap-2 text-sm">
        <span class="font-medium text-secondary whitespace-nowrap">Next check:</span>
        <span class="text-right text-primary">{{ getNextCheckText() }}</span>
      </div>

      <div class="flex items-start justify-between gap-2 text-sm" *ngIf="syncState?.error">
        <span class="font-medium text-[var(--error-500)] whitespace-nowrap">Error:</span>
        <span class="text-right text-[var(--error-500)] text-sm">{{ syncState?.error }}</span>
      </div>

      <div class="flex items-start justify-between gap-2 text-sm">
        <span class="font-medium text-primary">Pending Changes</span>
              <div class="text-sm text-tertiary">
                <a role="link" tabindex="0" aria-label="Open pending trips" class="pending-link pc-trips" (click)="openPendingChanges('trips'); $event.stopPropagation()" (keydown.enter)="openPendingChanges('trips'); $event.stopPropagation()">{{ unsavedCounts.trips }} trips</a>
                <span class="pc-sep"> â€¢ </span>
                <a role="link" tabindex="0" aria-label="Open pending shifts" class="pending-link pc-shifts" (click)="openPendingChanges('shifts'); $event.stopPropagation()" (keydown.enter)="openPendingChanges('shifts'); $event.stopPropagation()">{{ unsavedCounts.shifts }} shifts</a>
              </div>
      </div>

      <div class="pt-2">
        <app-quick-controls
          [hasUnsavedChanges]="hasUnsavedChanges"
          [status]="syncState?.status || 'idle'"
          [autoSaveEnabled]="autoSaveEnabled"
          [themePreference]="themePreference"
          (save)="forceSync()"
          (refresh)="updateFromSpreadsheet()"
          (autoSaveToggle)="toggleAutoSave($event)"
          (themeChange)="setTheme($event)">
        </app-quick-controls>
      </div>
    </div>

    <!-- Messages log (collapsible) -->
    <div class="messages-section border-t border-[var(--color-border-light)] bg-[var(--color-surface)]" *ngIf="messages.length > 0">
      <div class="messages-header px-4 py-3 flex justify-between items-center bg-overlay/5 hover:bg-overlay/10 cursor-pointer transition" (click)="toggleDetailedView(); $event.stopPropagation()">
        <span class="messages-title flex items-center gap-1 text-sm font-medium text-primary">
          <mat-icon class="expand-icon text-secondary" [class.expanded]="showDetailedView">
            expand_more
          </mat-icon>
          Activity Log ({{ messages.length }})
        </span>
        <app-base-button 
          [fab]="true" 
          fabStyle="mini"
          [noBackground]="true"
          [icon]="'clear_all'"
          [iconColor]="'var(--error-500)'"
          (clicked)="clearMessages()"
          class="clear-button flex h-8 w-8 items-center justify-center"
          matTooltip="Clear log">
        </app-base-button>
      </div>

      <div class="messages-list max-h-60 overflow-y-auto px-2 py-2 space-y-1" *ngIf="showDetailedView">
        <div 
          *ngFor="let message of messages.slice(-10).reverse()" 
          class="message-item flex gap-2 p-2 rounded border-l-4 transition"
          [ngClass]="'message-' + message.type">
          <mat-icon class="message-icon text-secondary">{{ getMessageIcon(message.type) }}</mat-icon>
          <div class="message-content flex-1 min-w-0">
            <div class="message-text text-sm text-primary break-words">{{ message.text }}</div>
            <div class="message-time text-xs text-tertiary">{{ formatTimestamp(message.timestamp) }}</div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-container *ngIf="mode === 'button'; else panelMode">
    <!-- Main status button with menu trigger -->
    <div 
      class="relative"
      cdkOverlayOrigin
      #syncOverlayOrigin="cdkOverlayOrigin"
      [matTooltip]="getTooltipText()"
      matTooltipPosition="below">
      <app-base-button
        [fab]="true"
        fabStyle="regular"
        [noBackground]="true"
        [icon]="getStatusIcon()"
        [iconColor]="'currentColor'"
        (clicked)="toggleMenu()"
        class="sync-button text-inverse hover:bg-white/10 transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-border-focus)]"
        [class.spinning]="syncState?.status === 'syncing'">
      </app-base-button>
      <!-- Progress badge for syncing state -->
      <span 
        *ngIf="syncState?.status === 'syncing' && (syncState?.totalItems || 0) > 0"
        class="progress-badge">
        {{ syncState?.itemsSynced }}/{{ syncState?.totalItems }}
      </span>
    </div>

    <!-- Dropdown popover with detailed sync information -->
    <ng-template
      cdkConnectedOverlay
      [cdkConnectedOverlayOrigin]="syncOverlayOrigin"
      [cdkConnectedOverlayOpen]="menuOpen"
      [cdkConnectedOverlayPositions]="overlayPositions"
      [cdkConnectedOverlayHasBackdrop]="true"
      [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'"
      (backdropClick)="closeMenu()"
      (overlayOutsideClick)="closeMenu()">
      <div class="sync-overlay-panel bg-[var(--color-surface)] border border-[var(--color-border-light)] shadow-[0_16px_40px_var(--shadow-heavy)] rounded-xl overflow-hidden" (click)="$event.stopPropagation()">
        <div class="sync-menu-content w-full min-w-[320px] max-w-[90vw] sm:max-w-[460px] bg-[var(--color-surface)] overflow-hidden p-0">
          <ng-container *ngTemplateOutlet="syncContent"></ng-container>
        </div>
      </div>
    </ng-template>
  </ng-container>

  <ng-template #panelMode>
    <div class="sync-menu-panel sync-menu-panel--embedded bg-[var(--color-surface)] border border-[var(--color-border-light)] shadow-[0_16px_40px_var(--shadow-heavy)] rounded-xl overflow-hidden">
      <div class="sync-menu-content embedded w-full min-w-[340px] max-w-[480px] bg-[var(--color-surface)] overflow-hidden p-0" (click)="$event.stopPropagation()">
        <ng-container *ngTemplateOutlet="syncContent"></ng-container>
      </div>
    </div>
  </ng-template>
</div>
