<div class="diagnostics-container p-4 bg-surface-2 rounded-lg shadow">
  <div class="diagnostics-actions mb-4 flex justify-end">
    <app-base-rect-button variant="primary" [icon]="'refresh'" [loading]="isLoading" (clicked)="runDiagnostics()">
      {{ isLoading ? 'Running...' : 'Run Diagnostics' }}
    </app-base-rect-button>
  </div>
  <div class="diagnostics-list space-y-6">
    <div *ngFor="let item of dataDiagnostics" class="mb-6">
      <div class="flex items-center gap-4 border-b pb-2 mb-2">
        <mat-icon [color]="getSeverityColor(item.severity)" class="text-2xl">
          {{ getSeverityIcon(item.severity) }}
        </mat-icon>
        <div class="flex-1">
          <div class="font-semibold text-lg text-primary">{{ item.name }}</div>
          <div class="text-gray-500 dark:text-gray-400 text-sm">{{ item.description }}</div>
        </div>
        <div class="text-xs bg-gray-200 dark:bg-gray-700 dark:text-gray-300 rounded px-2 py-1">{{ item.count }}</div>
      </div>
      <div *ngIf="item.items && item.items.length > 0" class="mt-2">
        <div class="font-medium mb-2 text-primary">
          Details ({{ item.items.length }} items{{ item.groups ? ' in ' + item.groups.length + ' groups' : '' }}):
        </div>
        <ng-container *ngIf="item.groups && item.groups.length > 0; else showIndividualItems">
          <div *ngFor="let group of item.groups; let groupIndex = index" class="mb-4">
            <div class="font-bold text-blue-700 dark:text-blue-300 mb-1">
              Duplicate Group {{ groupIndex + 1 }} ({{ group.length }} items):
            </div>
            <ul class="pl-4 border-l-2 border-blue-200 dark:border-blue-800">
              <li *ngFor="let problemItem of group" class="py-1">
                <ng-container [ngSwitch]="item.itemType">
                  <ng-container *ngSwitchCase="'shift'">
                    <strong>Shift:</strong>
                    <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                    <span *ngIf="problemItem.date">{{ problemItem.date }}</span>
                    <span *ngIf="problemItem.key"> ({{ problemItem.key }})</span>
                    <span *ngIf="problemItem.totalTrips !== undefined"> - Trips: {{ problemItem.totalTrips }}</span>
                    <span *ngIf="problemItem.start"> - Start: {{ problemItem.start }}</span>
                    <span *ngIf="problemItem.finish"> - End: {{ problemItem.finish }}</span>
                  </ng-container>
                  <ng-container *ngSwitchCase="'address'">
                    <strong>Address:</strong>
                    <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                    <span class="address-info">{{ problemItem.address }}</span>
                    <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                    <span *ngIf="problemItem.names && problemItem.names.length > 0"> - Names: {{ problemItem.names.join(', ') }}</span>
                  </ng-container>
                  <ng-container *ngSwitchCase="'place'">
                    <strong>Place:</strong>
                    <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                    <span class="place-info">{{ problemItem.place }}</span>
                    <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                    <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.length }}</span>
                  </ng-container>
                  <ng-container *ngSwitchCase="'name'">
                    <strong>Name:</strong>
                    <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                    <span class="name-info">{{ problemItem.name }}</span>
                    <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                    <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.join(', ') }}</span>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    <strong>Unknown Item Type:</strong> {{ item.itemType || 'undefined' }} - Check console for details
                  </ng-container>
                </ng-container>
              </li>
            </ul>
          </div>
        </ng-container>
        <ng-template #showIndividualItems>
          <ul class="pl-4">
            <li *ngFor="let problemItem of item.items" class="py-1">
              <ng-container [ngSwitch]="item.itemType">
                <ng-container *ngSwitchCase="'shift'">
                  <strong>Shift:</strong>
                  <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                  <span *ngIf="problemItem.date">{{ problemItem.date }}</span>
                  <span *ngIf="problemItem.key"> ({{ problemItem.key }})</span>
                  <span *ngIf="problemItem.totalTrips !== undefined"> - Trips: {{ problemItem.totalTrips }}</span>
                  <span *ngIf="problemItem.start"> - Start: {{ problemItem.start }}</span>
                  <span *ngIf="problemItem.finish"> - End: {{ problemItem.finish }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'trip'">
                  <strong>Trip:</strong>
                  <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                  <span *ngIf="problemItem.place" class="place-info">{{ problemItem.place }}</span>
                  <span *ngIf="problemItem.name" class="name-info">{{ problemItem.name }}</span>
                  <span *ngIf="problemItem.startLocation">{{ problemItem.startLocation }}</span>
                  <span *ngIf="problemItem.pickup">{{ problemItem.pickup }}</span>
                  <span *ngIf="(problemItem.startLocation || problemItem.pickup) && (problemItem.endLocation || problemItem.dropoff)"> â†’ </span>
                  <span *ngIf="problemItem.endLocation">{{ problemItem.endLocation }}</span>
                  <span *ngIf="problemItem.dropoff">{{ problemItem.dropoff }}</span>
                  <span *ngIf="problemItem.key"> (Shift: {{ problemItem.key }})</span>
                  <span *ngIf="problemItem.date"> - {{ problemItem.date }}</span>
                  <span *ngIf="problemItem.exclude"> - EXCLUDED</span>
                </ng-container>
                <ng-container *ngSwitchCase="'address'">
                  <strong>Address:</strong>
                  <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                  <span class="address-info">{{ problemItem.address }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.names && problemItem.names.length > 0"> - Names: {{ problemItem.names.join(', ') }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'place'">
                  <strong>Place:</strong>
                  <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                  <span class="place-info">{{ problemItem.place }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.length }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'name'">
                  <strong>Name:</strong>
                  <span *ngIf="problemItem.rowId" class="font-mono text-xs">[{{ problemItem.rowId }}]</span>
                  <span class="name-info">{{ problemItem.name }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.join(', ') }}</span>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <strong>Unknown Item Type:</strong> {{ item.itemType || 'undefined' }} - Check console for details
                </ng-container>
              </ng-container>
            </li>
          </ul>
        </ng-template>
      </div>
    </div>
  </div>
</div>