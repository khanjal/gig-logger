<div class="diagnostics-container p-4 bg-gray-50 rounded-lg shadow">
  <div class="diagnostics-actions mb-4 flex justify-end">
    <button mat-raised-button color="primary" (click)="runDiagnostics()" [disabled]="isLoading" class="flex items-center gap-2">
      <mat-icon>refresh</mat-icon>
      <span>{{ isLoading ? 'Running...' : 'Run Diagnostics' }}</span>
    </button>
  </div>
  <div class="diagnostics-list space-y-6">
    <div *ngFor="let item of dataDiagnostics" class="diagnostic-item-container bg-white rounded-lg shadow p-4">
      <div class="diagnostic-header flex items-center gap-4 border-b pb-2 mb-2">
        <mat-icon [color]="getSeverityColor(item.severity)" class="severity-icon text-2xl">
          {{ getSeverityIcon(item.severity) }}
        </mat-icon>
        <div class="diagnostic-info flex-1">
          <div class="diagnostic-title font-semibold text-lg">{{ item.name }}</div>
          <div class="diagnostic-description text-gray-500 text-sm">{{ item.description }}</div>
        </div>
        <div class="diagnostic-count text-xs bg-gray-200 rounded px-2 py-1">{{ item.count }}</div>
      </div>
      <!-- Detailed items list -->
      <div *ngIf="item.items && item.items.length > 0" class="diagnostic-details mt-2">
        <div class="details-header mb-2">
          <strong>Details ({{ item.items.length }} items{{ item.groups ? ' in ' + item.groups.length + ' groups' : '' }}):</strong>
        </div>
        <!-- Show grouped duplicates if available -->
        <div *ngIf="item.groups && item.groups.length > 0; else showIndividualItems" class="groups-list space-y-4">
          <div *ngFor="let group of item.groups; let groupIndex = index" class="duplicate-group border rounded bg-gray-100 p-2">
            <div class="group-header font-medium mb-1">
              <strong>Duplicate Group {{ groupIndex + 1 }} ({{ group.length }} items):</strong>
            </div>
            <div class="group-items space-y-1">
              <div *ngFor="let problemItem of group" class="diagnostic-item grouped-item p-2 bg-white rounded">
                <!-- For shifts -->
                <div *ngIf="item.itemType === 'shift'" class="shift-item">
                  <strong>Shift:</strong>&nbsp;
                  <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                  <span *ngIf="problemItem.date">{{ problemItem.date }}</span>
                  <span *ngIf="problemItem.key"> ({{ problemItem.key }})</span>
                  <span *ngIf="problemItem.totalTrips !== undefined"> - Trips: {{ problemItem.totalTrips }}</span>
                  <span *ngIf="problemItem.start"> - Start: {{ problemItem.start }}</span>
                  <span *ngIf="problemItem.finish"> - End: {{ problemItem.finish }}</span>
                </div>
                <!-- For addresses -->
                <div *ngIf="item.itemType === 'address'" class="address-item">
                  <strong>Address:</strong>&nbsp;
                  <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                  <span class="address-info">{{ problemItem.address }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.names && problemItem.names.length > 0"> - Names: {{ problemItem.names.join(', ') }}</span>
                </div>
                <!-- For places -->
                <div *ngIf="item.itemType === 'place'" class="place-item">
                  <strong>Place:</strong>&nbsp;
                  <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                  <span class="place-info">{{ problemItem.place }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.length }}</span>
                </div>
                <!-- For names -->
                <div *ngIf="item.itemType === 'name'" class="name-item">
                  <strong>Name:</strong>&nbsp;
                  <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                  <span class="name-info">{{ problemItem.name }}</span>
                  <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                  <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.join(', ') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Fallback to individual items display -->
        <ng-template #showIndividualItems>
          <div class="items-list space-y-2">
            <div *ngFor="let problemItem of item.items" class="diagnostic-item p-2 bg-gray-100 rounded">
              <!-- For shifts -->
              <div *ngIf="item.itemType === 'shift'" class="shift-item">
                <strong>Shift:</strong>&nbsp;
                <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                <span *ngIf="problemItem.date">{{ problemItem.date }}</span>
                <span *ngIf="problemItem.key"> ({{ problemItem.key }})</span>
                <span *ngIf="problemItem.totalTrips !== undefined"> - Trips: {{ problemItem.totalTrips }}</span>
                <span *ngIf="problemItem.start"> - Start: {{ problemItem.start }}</span>
                <span *ngIf="problemItem.finish"> - End: {{ problemItem.finish }}</span>
              </div>
              <!-- For trips -->
              <div *ngIf="item.itemType === 'trip'" class="trip-item">
                <strong>Trip:</strong>&nbsp;
                <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                <span *ngIf="problemItem.place" class="place-info">{{ problemItem.place }}</span>
                <span *ngIf="problemItem.name" class="name-info">{{ problemItem.name }}</span>
                <span *ngIf="problemItem.startLocation">{{ problemItem.startLocation }}</span>
                <span *ngIf="problemItem.pickup">{{ problemItem.pickup }}</span>
                <span *ngIf="(problemItem.startLocation || problemItem.pickup) && (problemItem.endLocation || problemItem.dropoff)"> â†’ </span>
                <span *ngIf="problemItem.endLocation">{{ problemItem.endLocation }}</span>
                <span *ngIf="problemItem.dropoff">{{ problemItem.dropoff }}</span>
                <span *ngIf="problemItem.key"> (Shift: {{ problemItem.key }})</span>
                <span *ngIf="problemItem.date"> - {{ problemItem.date }}</span>
                <span *ngIf="problemItem.exclude"> - EXCLUDED</span>
              </div>
              <!-- For addresses -->
              <div *ngIf="item.itemType === 'address'" class="address-item">
                <strong>Address:</strong>&nbsp;
                <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                <span class="address-info">{{ problemItem.address }}</span>
                <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                <span *ngIf="problemItem.names && problemItem.names.length > 0"> - Names: {{ problemItem.names.join(', ') }}</span>
              </div>
              <!-- For places -->
              <div *ngIf="item.itemType === 'place'" class="place-item">
                <strong>Place:</strong>&nbsp;
                <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                <span class="place-info">{{ problemItem.place }}</span>
                <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.length }}</span>
              </div>
              <!-- For names -->
              <div *ngIf="item.itemType === 'name'" class="name-item">
                <strong>Name:</strong>&nbsp;
                <span *ngIf="problemItem.rowId" class="row-id font-mono">[{{ problemItem.rowId }}]</span>
                <span class="name-info">{{ problemItem.name }}</span>
                <span *ngIf="problemItem.trips !== undefined"> - Trips: {{ problemItem.trips }}</span>
                <span *ngIf="problemItem.addresses && problemItem.addresses.length > 0"> - Addresses: {{ problemItem.addresses.join(', ') }}</span>
              </div>
              <!-- Fallback for any other items -->
              <div *ngIf="item.itemType !== 'shift' && item.itemType !== 'trip' && item.itemType !== 'address' && item.itemType !== 'place' && item.itemType !== 'name'" class="unknown-item">
                <strong>Unknown Item Type:</strong> {{ item.itemType || 'undefined' }} - Check console for details
              </div>
            </div>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>