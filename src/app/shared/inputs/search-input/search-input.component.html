<form [formGroup]="searchForm">
    <mat-form-field class="field-full-width" appearance="outline">
            <mat-label>{{fieldName}}</mat-label>
            <!-- Single input with conditional autocomplete behavior -->
            <input 
                matInput
                type="text"
                [matAutocomplete]="autoInput"
                formControlName="searchInput"
                (input)="onInputChange($event)"
                (focus)="onFocus()"
                (blur)="onBlur()"
                [required]="isRequired"
                focus-scroll
                [focusScrollOffset]="computedScrollOffset"
                #searchInput
                #autocompleteTrigger="matAutocompleteTrigger"
            />
            <mat-autocomplete autoActiveFirstOption #autoInput="matAutocomplete">
                <!-- Loading spinner for Google search -->
                <mat-option *ngIf="isGoogleSearching" disabled>
                    <div class="option-content" style="display: flex; align-items: center; justify-content: center; padding: 16px;">
                        <mat-spinner diameter="20" strokeWidth="3" style="margin-right: 8px;"></mat-spinner>
                        <span>Searching Google...</span>
                    </div>
                </mat-option>
                
                <!-- No Google results message -->
                <mat-option *ngIf="showNoGoogleResults && !isGoogleSearching" disabled>
                    <div class="option-content" style="display: flex; align-items: center; justify-content: center; padding: 16px; color: #666;">
                        <mat-icon style="margin-right: 8px;">search_off</mat-icon>
                        <span>No Google results found</span>
                    </div>
                </mat-option>
                
                <cdk-virtual-scroll-viewport 
                    *ngIf="filteredItemsArray.length > 0 && !isGoogleSearching"
                    [itemSize]="getItemSize()" 
                    [style.height.px]="getViewportHeight(filteredItemsArray)" 
                    class="virtual-scroll-viewport"
                    minBufferPx="288" maxBufferPx="576">
                <mat-option 
                    *cdkVirtualFor="let item of filteredItemsArray" 
                    [value]="item.name" 
                    (click)="onInputSelect(item)"
                    class="search-result-option"
                    #matOption>
                    <div class="option-content" style="display: flex; flex-direction: column; align-items: flex-start; padding: 8px 0; min-height: 48px;">
                        <div style="display: flex; align-items: center; width: 100%; line-height: 1.2;">
                            <span class="google-indicator" *ngIf="isGoogleResult(item)" style="margin-right: 6px;">
                                <svg width="16" height="16" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="google-logo">
                                    <path d="M17.64 9.20455C17.64 8.56827 17.5827 7.95455 17.48 7H9V10.7814H13.8436C13.635 11.97 13.0009 12.9386 12.0477 13.5614V15.8195H13.9564C16.6581 14.2527 17.64 11.9455 17.64 9.20455Z" fill="#4285F4"/>
                                    <path d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5614C11.2418 14.1013 10.2109 14.4204 9 14.4204C6.65591 14.4204 4.67182 12.8377 3.96409 10.71H1.95727V13.0418C4.43591 13.9836 6.64773 18 9 18Z" fill="#34A853"/>
                                    <path d="M3.96409 10.71C4.08727 10.328 4 9.52273 4 9C4 8.47273 4.08727 7.67273 3.96409 7.29V4.95818H0.957273C0.347727 6.17364 0 7.54545 0 9C0 10.4545 0.347727 11.8264 0.957273 13.0418L3.96409 10.71Z" fill="#FBBC05"/>
                                    <path d="M9 4.57955C10.3218 4.57955 11.5079 5.03364 12.4409 5.92545L15 3.36364C13.4564 1.95 11.2309 1 9 1C6.64773 1 4.43591 3.01636 1.95727 4.95818L3.96409 7.29C4.67182 5.16227 6.65591 3.57955 9 3.57955Z" fill="#EA4335"/>
                                </svg>
                            </span>
                            <span class="trips-indicator" *ngIf="item.saved && item.trips > 0" style="margin-right: 6px; font-size: 0.9em; color: #666;">
                                ({{ item.trips }})
                            </span>
                            <span class="option-text" [ngClass]="{'option-text-large': item.address, 'option-text-normal': !item.address}">{{ item.name }}</span>
                        </div>
                        <div *ngIf="item.address" class="option-address" style="font-size: 0.8em; color: #888; margin-top: 4px; padding-left: 22px; line-height: 1.1; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: calc(100% - 22px);">{{ item.address | shortaddress:item.name:0 }}</div>
                    </div>
                </mat-option>
                </cdk-virtual-scroll-viewport>
            </mat-autocomplete>

            <!-- Google search icon - shows when text is entered but no selection made -->
            <button mat-icon-button matSuffix class="standard-button" 
                    *ngIf="isGoogleSearchType() && value && !hasSelection && !isGoogleSearching"
                    color="primary"
                    aria-label="Trigger Google Autocomplete Search"
                    title="Search with Google Autocomplete"
                    (click)="triggerGoogleSearch(); $event.stopPropagation(); $event.preventDefault();">
                <mat-icon>search</mat-icon>
            </button>

            <!-- Google Maps icon - shows when text is entered and a selection has been made -->
            <button mat-icon-button matSuffix class="standard-button"
                    *ngIf="isGoogleSearchType() && value && hasSelection"
                    color="primary"
                    aria-label="Open Google Maps"
                    title="Open Google Maps with this search"
                    (click)="openGoogleMaps(); $event.stopPropagation(); $event.preventDefault();">
                <mat-icon>map</mat-icon>
            </button>

            <!-- Clear button - shows when any text is entered -->
            <button mat-icon-button matSuffix class="standard-button" 
                    *ngIf="value" 
                    color="accent" 
                    aria-label="Clear Field" 
                    (click)="onClear(); $event.stopPropagation(); $event.preventDefault();">
                <mat-icon>clear</mat-icon>
            </button>
        </mat-form-field>
</form>
