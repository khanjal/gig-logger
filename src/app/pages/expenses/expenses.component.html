<div id="expenses-top"></div>
<div class="container mx-auto p-4 max-w-4xl">
  <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-blue-700 flex-1">Expenses</h1>
    <button *ngIf="!showAddForm && !editingExpenseId" mat-mini-fab color="primary" class="add-button !w-9 !h-9" (click)="showAddForm = true; resetForm()" title="Add Expense">
      <mat-icon class="text-base">add</mat-icon>
    </button>
    <button *ngIf="showAddForm && !editingExpenseId" mat-mini-fab color="warn" class="hide-button !w-9 !h-9" (click)="showAddForm = false" title="Close Form">
      <mat-icon class="text-base">close</mat-icon>
    </button>
  </div>

  <form *ngIf="showAddForm || editingExpenseId" [formGroup]="expenseForm" (ngSubmit)="addExpense()" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white p-6 rounded-lg shadow mb-8">
    <mat-form-field class="w-full col-span-1 md:col-span-2" appearance="outline">
      <mat-label>Date</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="date" />
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>
    <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4">
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Amount</mat-label>
        <input matInput type="number" formControlName="amount" step="0.01" min="0" />
      </mat-form-field>
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select formControlName="category" placeholder="Search or add category">
          <mat-option *ngFor="let cat of categories" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <mat-form-field class="w-full col-span-1 md:col-span-4" appearance="outline">
      <mat-label>Note</mat-label>
      <input matInput type="text" formControlName="note" maxlength="100" />
    </mat-form-field>
    <div class="col-span-1 md:col-span-4 flex justify-end gap-2">
      <button mat-raised-button color="primary" type="submit" [disabled]="expenseForm.invalid" class="font-semibold">
        {{ editingExpenseId ? 'Update Expense' : 'Add Expense' }}
      </button>
      <button *ngIf="editingExpenseId" mat-stroked-button color="warn" type="button" (click)="cancelEdit()">Cancel</button>
    </div>
  </form>

  <div class="expenses-list-container w-full max-w-3xl mx-auto px-4 md:px-8 lg:px-12 py-6">
    <div *ngFor="let month of (groupedExpenses | keyvalue:sortByMonth)">
      <div class="flex items-end justify-between mb-0 py-1">
        <h3 class="text-lg font-bold text-blue-700 pb-0">{{ month.key | date:'MMMM yyyy' }}</h3>
        <div class="text-right text-base font-semibold text-blue-900 mb-2">
          Total: {{ getMonthTotal(month.value) | currency }}
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow mb-8">
          <thead>
            <tr class="bg-blue-100">
              <th class="py-2 px-4 text-left font-semibold">Date</th>
              <th class="py-2 px-4 text-left font-semibold">Amount</th>
              <th class="py-2 px-4 text-left font-semibold">Category</th>
               <th class="py-2 px-4 text-left font-semibold"></th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let expense of month.value | orderBy:'date':'asc'">
              <tr class="even:bg-gray-50">
                <td class="py-2 px-4 align-top">{{ expense.date | date:'d' | ordinal }}</td>
                <td class="py-2 px-4 align-top">{{ expense.amount | currency }}</td>
                <td class="py-2 px-4 align-top">{{ expense.category }}</td>
                <td class="py-2 px-4 align-top flex items-center gap-2">
                  <button mat-icon-button color="primary" aria-label="Edit" (click)="editExpense(expense)">
                    <mat-icon fontIcon="edit"></mat-icon>
                  </button>
                  <button mat-icon-button color="warn" aria-label="Delete" (click)="deleteExpense(expense)">
                    <mat-icon fontIcon="delete"></mat-icon>
                  </button>
                </td>
              </tr>
              <tr *ngIf="expense.note">
                <td></td>
                <td colspan="2" class="py-1 px-4 text-gray-500 italic">"{{ expense.note }}"</td>
                  <td></td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
