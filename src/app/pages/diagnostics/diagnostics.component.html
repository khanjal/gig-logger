<div class="container flex flex-col min-h-screen p-4 md:p-8 lg:p-12 max-w-5xl mx-auto">
  <div class="flex flex-wrap gap-4 mb-6 items-center justify-between">
    <h1 class="text-2xl font-bold text-blue-700 flex-1">Data Diagnostics</h1>
    <button mat-raised-button color="primary" (click)="runDiagnostics()" [disabled]="isLoading" class="!min-w-[140px]">
      <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      {{ isLoading ? 'Running...' : 'Run Check' }}
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6" *ngIf="dataDiagnostics.length > 0">
    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
      <div class="flex items-center gap-2">
        <mat-icon class="text-red-500">error</mat-icon>
        <div>
          <div class="text-2xl font-bold text-red-700">{{ getCountBySeverity('error') }}</div>
          <div class="text-sm text-red-600">Errors</div>
        </div>
      </div>
    </div>
    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-lg">
      <div class="flex items-center gap-2">
        <mat-icon class="text-orange-500">warning</mat-icon>
        <div>
          <div class="text-2xl font-bold text-orange-700">{{ getCountBySeverity('warning') }}</div>
          <div class="text-sm text-orange-600">Warnings</div>
        </div>
      </div>
    </div>
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
      <div class="flex items-center gap-2">
        <mat-icon class="text-blue-500">info</mat-icon>
        <div>
          <div class="text-2xl font-bold text-blue-700">{{ getCountBySeverity('info') }}</div>
          <div class="text-sm text-blue-600">Info</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && dataDiagnostics.length === 0" class="text-center py-12">
    <mat-icon class="text-gray-300 !text-[64px] !w-16 !h-16 mx-auto mb-4">check_circle</mat-icon>
    <h2 class="text-xl font-semibold text-gray-600 mb-2">No Diagnostics Run Yet</h2>
    <p class="text-gray-500">Click "Run Check" to analyze your data for potential issues.</p>
  </div>

  <!-- All Clear State -->
  <div *ngIf="!isLoading && dataDiagnostics.length > 0 && getTotalIssues() === 0" class="text-center py-12 bg-green-50 rounded-lg border border-green-200">
    <mat-icon class="text-green-500 !text-[64px] !w-16 !h-16 mx-auto mb-4">verified</mat-icon>
    <h2 class="text-xl font-semibold text-green-700 mb-2">All Clear!</h2>
    <p class="text-green-600">No issues found in your data. Everything looks good!</p>
  </div>

  <!-- Diagnostic Items as Expansion Panels -->
  <mat-accordion class="diagnostics-accordion" *ngIf="!isLoading && getTotalIssues() > 0">
    <mat-expansion-panel *ngFor="let item of dataDiagnostics" [disabled]="item.count === 0" [class.opacity-50]="item.count === 0">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon [class.text-red-500]="item.severity === 'error'"
                    [class.text-orange-500]="item.severity === 'warning'"
                    [class.text-blue-500]="item.severity === 'info'">
            {{ getSeverityIcon(item.severity) }}
          </mat-icon>
          <span>{{ item.name }}</span>
        </mat-panel-title>
        <mat-panel-description>
          <span class="hidden md:inline text-gray-600 text-sm mr-2">{{ item.description }}</span>
          <span class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-semibold flex-shrink-0"
                [class.bg-red-100]="item.severity === 'error' && item.count > 0"
                [class.text-red-700]="item.severity === 'error' && item.count > 0"
                [class.bg-orange-100]="item.severity === 'warning' && item.count > 0"
                [class.text-orange-700]="item.severity === 'warning' && item.count > 0"
                [class.bg-gray-100]="item.count === 0"
                [class.text-gray-600]="item.count === 0">
            {{ item.count }}
          </span>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <!-- Panel Content -->
      <div class="mt-4 px-4 pb-4">
        <p class="text-sm text-gray-600 mb-4 md:hidden">{{ item.description }}</p>
        
        <!-- Grouped Items (Duplicates) -->
        <div *ngIf="item.groups && item.groups.length > 0" class="space-y-4">
          <div class="text-sm text-gray-600 mb-3 font-medium">
            Found {{ item.items?.length }} items in {{ item.groups.length }} duplicate groups
          </div>
          
          <div *ngFor="let group of item.groups; let groupIndex = index" class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-100 px-4 py-2 border-b border-gray-200 flex items-center justify-between">
              <span class="font-semibold text-sm text-gray-700">Group {{ groupIndex + 1 }}</span>
              <span class="text-xs bg-gray-200 px-2 py-1 rounded">{{ group.length }} items</span>
            </div>
            <div class="divide-y divide-gray-200">
              <div *ngFor="let problemItem of group" class="p-3 hover:bg-gray-100 transition-colors">
                <ng-container *ngTemplateOutlet="itemDisplay; context: {item: problemItem, type: item.itemType}"></ng-container>
              </div>
            </div>
          </div>
        </div>

        <!-- Individual Items (Non-duplicates) -->
        <div *ngIf="!item.groups || item.groups.length === 0" class="space-y-2">
          <div *ngFor="let problemItem of item.items" class="bg-gray-50 rounded-lg border border-gray-200 p-3 hover:bg-gray-100 transition-colors">
            <ng-container *ngTemplateOutlet="itemDisplay; context: {item: problemItem, type: item.itemType}"></ng-container>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>

<!-- Reusable Item Display Template -->
<ng-template #itemDisplay let-item="item" let-type="type">
  <div class="flex flex-col gap-1">
    <!-- Shift Item -->
    <div *ngIf="type === 'shift'" class="flex flex-wrap items-center gap-2">
      <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-mono">ID: {{ item.rowId }}</span>
      <span class="font-semibold text-gray-800">{{ item.date }}</span>
      <span class="text-gray-600 text-sm">({{ item.key }})</span>
      <span *ngIf="item.totalTrips !== undefined" class="text-sm text-gray-600">{{ item.totalTrips }} trips</span>
      <span *ngIf="item.start" class="text-sm text-gray-500">{{ item.start }} - {{ item.finish }}</span>
    </div>

    <!-- Trip Item -->
    <div *ngIf="type === 'trip'" class="flex flex-wrap items-center gap-2">
      <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-mono">ID: {{ item.rowId }}</span>
      <span class="font-semibold text-gray-800">{{ item.date }}</span>
      <span class="text-gray-600 text-sm">({{ item.key }})</span>
      <span *ngIf="item.place" class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">{{ item.place }}</span>
      <span *ngIf="item.name" class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">{{ item.name }}</span>
      <span *ngIf="item.startLocation || item.pickup" class="text-sm text-gray-500">{{ item.startLocation || item.pickup }}</span>
      <span *ngIf="(item.startLocation || item.pickup) && (item.endLocation || item.dropoff)" class="text-gray-400">â†’</span>
      <span *ngIf="item.endLocation || item.dropoff" class="text-sm text-gray-500">{{ item.endLocation || item.dropoff }}</span>
      <span *ngIf="item.exclude" class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">EXCLUDED</span>
    </div>

    <!-- Address Item -->
    <div *ngIf="type === 'address'" class="flex flex-wrap items-center gap-2">
      <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-mono">ID: {{ item.rowId }}</span>
      <span class="font-semibold text-gray-800">{{ item.address }}</span>
      <span *ngIf="item.trips !== undefined" class="text-sm text-gray-600">{{ item.trips }} trips</span>
      <span *ngIf="item.names && item.names.length > 0" class="text-sm text-gray-500">Names: {{ item.names.join(', ') }}</span>
    </div>

    <!-- Place Item -->
    <div *ngIf="type === 'place'" class="flex flex-wrap items-center gap-2">
      <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-mono">ID: {{ item.rowId }}</span>
      <span class="font-semibold text-gray-800">{{ item.place }}</span>
      <span *ngIf="item.trips !== undefined" class="text-sm text-gray-600">{{ item.trips }} trips</span>
      <span *ngIf="item.addresses && item.addresses.length > 0" class="text-sm text-gray-500">{{ item.addresses.length }} addresses</span>
    </div>

    <!-- Name Item -->
    <div *ngIf="type === 'name'" class="flex flex-wrap items-center gap-2">
      <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-mono">ID: {{ item.rowId }}</span>
      <span class="font-semibold text-gray-800">{{ item.name }}</span>
      <span *ngIf="item.trips !== undefined" class="text-sm text-gray-600">{{ item.trips }} trips</span>
      <span *ngIf="item.addresses && item.addresses.length > 0" class="text-sm text-gray-500">Addresses: {{ item.addresses.join(', ') }}</span>
    </div>
  </div>
</ng-template>
