<div class="container flex flex-col min-h-screen p-4 md:p-8 lg:p-12 max-w-5xl mx-auto">
  <div class="flex flex-wrap gap-4 mb-6 items-center justify-between">
    <h1 class="text-2xl font-bold flex-1">Data Diagnostics</h1>
    <button mat-raised-button color="primary" (click)="runDiagnostics()" [disabled]="isLoading" class="!min-w-[140px]">
      <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      {{ isLoading ? 'Running...' : 'Run Check' }}
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-3 gap-4 mb-6" *ngIf="dataDiagnostics.length > 0">
    <div class="bg-red-50 dark:bg-red-950 border-l-4 border-error-500 p-4 rounded-lg">
      <div class="flex items-center gap-1 text-2xl font-bold text-red-700 dark:text-red-400 mb-1 lg:mb-0 leading-none">
        <mat-icon class="text-red-500 !text-2xl !w-8 !h-8 !leading-none relative top-0.5">error</mat-icon>
        <span>{{ getCountBySeverity('error') }}</span>
        <span class="hidden lg:inline text-sm text-red-600 dark:text-red-400 font-normal ml-1">Errors</span>
      </div>
      <div class="text-sm text-red-600 dark:text-red-400 text-center lg:hidden">Errors</div>
    </div>
    <div class="bg-orange-50 dark:bg-orange-950 border-l-4 border-warning-500 p-4 rounded-lg">
      <div class="flex items-center gap-1 text-2xl font-bold text-orange-700 dark:text-orange-400 mb-1 lg:mb-0 leading-none">
        <mat-icon class="text-orange-500 !text-2xl !w-8 !h-8 !leading-none relative top-0.5">warning</mat-icon>
        <span>{{ getCountBySeverity('warning') }}</span>
        <span class="hidden lg:inline text-sm text-orange-600 dark:text-orange-400 font-normal ml-1">Warnings</span>
      </div>
      <div class="text-sm text-orange-600 dark:text-orange-400 text-center lg:hidden">Warnings</div>
    </div>
    <div class="bg-blue-50 dark:bg-blue-950 border-l-4 border-blue-500 p-4 rounded-lg">
      <div class="flex items-center gap-1 text-2xl font-bold text-blue-700 dark:text-blue-300 mb-1 lg:mb-0 leading-none">
        <mat-icon class="text-blue-500 !text-2xl !w-8 !h-8 !leading-none relative top-0.5">info</mat-icon>
        <span>{{ getCountBySeverity('info') }}</span>
        <span class="hidden lg:inline text-sm text-blue-600 dark:text-blue-400 font-normal ml-1">Info</span>
      </div>
      <div class="text-sm text-blue-600 dark:text-blue-400 text-center lg:hidden">Info</div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-12">
    <mat-icon class="text-blue-500 dark:text-blue-400 !text-[64px] !w-16 !h-16 mx-auto mb-4 animate-spin">refresh</mat-icon>
    <h2 class="text-xl font-semibold text-blue-600 dark:text-blue-400 mb-2">Running Diagnostics...</h2>
    <p class="text-gray-600 dark:text-gray-400">Analyzing your data for potential issues.</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && dataDiagnostics.length === 0" class="text-center py-12">
    <mat-icon class="text-gray-300 dark:text-gray-600 !text-[64px] !w-16 !h-16 mx-auto mb-4">check_circle</mat-icon>
    <h2 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Diagnostics Run Yet</h2>
    <p class="text-gray-500 dark:text-gray-400">Click "Run Check" to analyze your data for potential issues.</p>
  </div>

  <!-- All Clear State -->
  <div *ngIf="!isLoading && dataDiagnostics.length > 0 && getTotalIssues() === 0" class="text-center py-12 bg-success-500/10 rounded-lg border border-success-200 dark:border-success-700">
    <mat-icon class="text-green-500 !text-[64px] !w-16 !h-16 mx-auto mb-4">verified</mat-icon>
    <h2 class="text-xl font-semibold text-green-700 dark:text-green-400 mb-2">All Clear!</h2>
    <p class="text-green-600 dark:text-green-400">No issues found in your data. Everything looks good!</p>
  </div>

  <!-- Diagnostic Items as Expansion Panels -->
  <mat-accordion class="diagnostics-accordion" *ngIf="!isLoading && getTotalIssues() > 0">
    <mat-expansion-panel *ngFor="let item of dataDiagnostics" [disabled]="item.count === 0" [class.opacity-50]="item.count === 0">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon [class.text-red-500]="item.severity === 'error'"
                    [class.text-orange-500]="item.severity === 'warning'"
                    [class.text-blue-500]="item.severity === 'info'">
            {{ getSeverityIcon(item.severity) }}
          </mat-icon>
          <span>{{ item.name }}</span>
        </mat-panel-title>
        <mat-panel-description>
          <span class="hidden md:inline text-gray-600 dark:text-gray-300 text-sm mr-2">{{ item.description }}</span>
                <span class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-semibold flex-shrink-0"
                [class.bg-error-500/20]="item.severity === 'error' && item.count > 0"
                [class.text-red-700]="item.severity === 'error' && item.count > 0"
                [class.bg-orange-100]="item.severity === 'warning' && item.count > 0"
                [class.text-orange-700]="item.severity === 'warning' && item.count > 0"
                [class.bg-gray-100]="item.count === 0"
                [class.text-gray-600]="item.count === 0"
                [ngClass]="{
                  'dark:text-red-400': item.severity === 'error' && item.count > 0,
                  'dark:bg-orange-900/30': item.severity === 'warning' && item.count > 0,
                  'dark:text-orange-400': item.severity === 'warning' && item.count > 0,
                  'dark:bg-gray-800': item.count === 0,
                  'dark:text-gray-400': item.count === 0
                }">
            {{ item.count }}
          </span>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <!-- Panel Content -->
      <div class="mt-4 px-4 pb-4">
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 md:hidden">{{ item.description }}</p>
        
        <!-- Bulk Fix Button for Missing Durations -->
        <div *ngIf="item.name === 'Shifts Missing Time Duration' && item.count > 0" class="mb-4">
          <button *ngIf="!isBulkFixing" mat-raised-button color="primary" (click)="bulkFixShiftDurations()">
            <mat-icon>build</mat-icon>
            Fix All ({{ item.count }})
          </button>
          <div *ngIf="isBulkFixing" class="flex items-center gap-2 text-blue-600">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Fixing...</span>
          </div>
        </div>
        <div *ngIf="item.name === 'Trips Missing Duration' && item.count > 0" class="mb-4">
          <button *ngIf="!isBulkFixing" mat-raised-button color="primary" (click)="bulkFixTripDurations()">
            <mat-icon>build</mat-icon>
            Fix All ({{ item.count }})
          </button>
          <div *ngIf="isBulkFixing" class="flex items-center gap-2 text-blue-600">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Fixing...</span>
          </div>
        </div>
        
        <!-- Grouped Items (Duplicates) -->
        <div *ngIf="item.groups && item.groups.length > 0" class="space-y-4">
          <div class="text-sm text-gray-600 dark:text-gray-200 mb-3 font-medium">
            Found {{ item.items?.length }} items in {{ item.groups.length }} duplicate groups
          </div>
          
          <app-diagnostic-group
            *ngFor="let group of item.groups; let groupIndex = index"
            [group]="group"
            [groupIndex]="groupIndex"
            [itemType]="item.itemType!"
            [(selectedValue)]="selectedValue[groupIndex]"
            [(selectedShiftToDelete)]="selectedShiftToDelete[groupIndex]"
            (merge)="mergeDuplicates($event.group, $event.value, $event.itemType)"
            (deleteShift)="markShiftForDelete($event.group, $event.shiftId, $event.groupIndex)">
          </app-diagnostic-group>
        </div>

        <!-- Individual Items (Non-duplicates) -->
        <div *ngIf="!item.groups || item.groups.length === 0" class="space-y-2">
          <div *ngFor="let problemItem of item.items" class="bg-surface-2 rounded-lg border border-soft p-3 hover:bg-surface-3 transition-colors" [class.opacity-50]="(problemItem.trips === 0 && (item.itemType === 'place' || item.itemType === 'name' || item.itemType === 'address')) || problemItem.fixed" [class.bg-success-500/20]="(problemItem.trips === 0 && (item.itemType === 'place' || item.itemType === 'name' || item.itemType === 'address')) || problemItem.fixed">
            <div *ngIf="problemItem.fixed" class="flex items-center gap-2 text-green-600 dark:text-green-400 text-sm mb-2">
              <mat-icon class="!text-base">check_circle</mat-icon>
              <span>{{ item.name === 'Orphaned Trips' ? 'Fixed - Shift created' : 'Fixed successfully' }}</span>
            </div>
            <div class="flex items-center justify-between gap-2">
              <div class="flex-1">
                <app-diagnostic-item
                  [item]="problemItem"
                  [itemType]="item.itemType!"
                  [diagnosticName]="item.name"
                  (fixShiftDuration)="fixShiftDuration($event)"
                  (fixTripDuration)="fixTripDuration($event)">
                </app-diagnostic-item>
              </div>
              <button *ngIf="item.name === 'Orphaned Trips' && !problemItem.fixed" 
                      mat-icon-button color="primary" 
                      (click)="createShiftFromTrip(problemItem)"
                      matTooltip="Create shift from trip">
                <mat-icon>add</mat-icon>
              </button>
            </div>
            <div *ngIf="item.name === 'Trip Places Missing Address'" class="mt-2 pt-2 border-t border-soft">
              <div *ngIf="problemItem.addressApplied" class="flex items-center gap-2 text-green-600 dark:text-green-400 text-sm mb-2">
                <mat-icon class="!text-base">check_circle</mat-icon>
                <span>Address applied successfully</span>
              </div>
              <div class="flex items-center gap-2">
                <select *ngIf="problemItem.availableAddresses && problemItem.availableAddresses.length > 0" 
                        [(ngModel)]="selectedAddress[problemItem.rowId]" 
                        class="border border-soft rounded px-2 py-1 text-sm flex-1 min-w-0 max-w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                  <option [value]="undefined">Select address...</option>
                  <option *ngFor="let addr of problemItem.availableAddresses" [value]="addr" [title]="addr">{{ addr }}</option>
                </select>
                <input *ngIf="!problemItem.availableAddresses || problemItem.availableAddresses.length === 0"
                       [(ngModel)]="selectedAddress[problemItem.rowId]"
                       placeholder="Enter address..."
                       class="border border-soft rounded px-2 py-1 text-sm flex-1 min-w-0 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                <button mat-icon-button color="primary" 
                        [disabled]="!selectedAddress[problemItem.rowId]"
                        (click)="applyAddressToTrip(problemItem, selectedAddress[problemItem.rowId])"
                        matTooltip="Apply address">
                  <mat-icon>check</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>

<app-back-to-top></app-back-to-top>
