<div class="container" id="addTrip">
    <div><app-current-average class="field-right"></app-current-average></div>
    
    <quick-form (parentReload)="load()"></quick-form>

    @if (unsavedTrips.length > 0 && !pollingEnabled) {
        <div class="row-grid">
            <button mat-fab extended class="button" color="accent" [class.spinner]="saving" [disabled]="saving || defaultSheet?.id === demoSheetId" (click)="confirmSaveTripsDialog()"><mat-icon>save</mat-icon> Save Trips to Spreadsheet</button>
        </div>
    }
    
    @if (!unsavedTrips.length || pollingEnabled) {
        <div class="row-grid">
            <button mat-fab extended color="primary" class="button" [class.spinner]="reloading" [disabled]="reloading || unsavedTrips.length > 0"  (click)="confirmLoadTripsDialog()"><mat-icon>refresh</mat-icon> Update from Spreadsheet</button>
        </div>
    }
    
    <h2 id="todaysTrips">
        @if (todaysTrips.length > 0) {
            Today's Trips
        }
        @else {
            No Recent Trips
        }
        <mat-slide-toggle class="field-right" (change)="changePolling()">
            Auto Save
        </mat-slide-toggle>
    </h2>

    @for (trip of todaysTrips; track $index) {
        <div [id]="trip.rowId" [ngClass]="{'mat-card': todaysTrips.length % 2 != 0, 'mat-card-reverse': todaysTrips.length % 2 == 0, 'mat-card-disabled': trip.exclude == true || trip.action == actionEnum.Delete}">
            <trips-quick-view [trip]="trip"></trips-quick-view>
            <div mat-card class="row-flex button-bar">
                <button mat-fab extended color="primary" class="button-left" (click)="editUnsavedTrip(trip)"><mat-icon>edit</mat-icon> Edit</button>
                <button mat-fab extended color="accent" (click)="setPickupTime(trip)" *ngIf="!trip.pickupTime && !trip.dropoffTime && !trip.exclude"><mat-icon>update</mat-icon> Pickup</button>
                <button mat-fab extended color="accent" (click)="setDropoffTime(trip)" *ngIf="trip.pickupTime && !trip.dropoffTime && !trip.exclude"><mat-icon>schedule</mat-icon> Dropoff</button>
                <button mat-fab color="primary" [matMenuTriggerFor]="menu" aria-label="Trip menu">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu color="primary" #menu="matMenu">
                    <!-- <button mat-menu-item>
                        <mat-icon>block</mat-icon>
                        <span>Exclude</span>
                    </button> -->
                    <button mat-menu-item (click)="nextUnsavedTrip(trip)">
                        <mat-icon>pin_drop</mat-icon>
                        <span>Next</span>
                    </button>
                    <button mat-menu-item (click)="cloneUnsavedTrip(trip)">
                        <mat-icon>content_copy</mat-icon>
                        <span>Clone</span>
                    </button>
                    @if (trip.action != actionEnum.Delete) {
                        <button mat-menu-item [attr.color]="'warn'" (click)="confirmDeleteTripDialog(trip)">
                            <mat-icon color="warn">delete</mat-icon>
                            <span>Delete</span>
                        </button>
                    }
                    @else {
                        <button mat-menu-item [attr.color]="'primary'" (click)="restoreTrip(trip)">
                            <mat-icon color="primary">restore</mat-icon>
                            <span>Restore</span>
                        </button>
                    }
                </mat-menu>
            </div>
        </div>
    }

    <br/>
    <h2 id="yesrterdaysTrips" *ngIf="yesrterdaysTrips.length > 0">Yesterday's Trips</h2>

    @for (trip of yesrterdaysTrips; track $index) {
        <div [id]="trip.rowId" [ngClass]="{'mat-card': yesrterdaysTrips.length % 2 != 0, 'mat-card-reverse': yesrterdaysTrips.length % 2 == 0, 'mat-card-disabled': trip.exclude == true || trip.action == actionEnum.Delete}">
            <trips-quick-view [trip]="trip"></trips-quick-view>
            <div mat-card class="row-flex button-bar">
                <button mat-fab extended color="primary" class="button-left" (click)="editUnsavedTrip(trip)"><mat-icon>edit</mat-icon> Edit</button>
                <button mat-fab extended color="accent" (click)="setPickupTime(trip)" *ngIf="!trip.pickupTime && !trip.dropoffTime && !trip.exclude"><mat-icon>update</mat-icon> Pickup</button>
                <button mat-fab extended color="accent" (click)="setDropoffTime(trip)" *ngIf="trip.pickupTime && !trip.dropoffTime && !trip.exclude"><mat-icon>schedule</mat-icon> Dropoff</button>
                <button mat-fab color="primary" [matMenuTriggerFor]="menu" aria-label="Trip menu">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu color="primary" #menu="matMenu">
                    <!-- <button mat-menu-item>
                        <mat-icon>block</mat-icon>
                        <span>Exclude</span>
                    </button> -->
                    <button mat-menu-item (click)="nextUnsavedTrip(trip)">
                        <mat-icon>pin_drop</mat-icon>
                        <span>Next</span>
                    </button>
                    <button mat-menu-item (click)="cloneUnsavedTrip(trip)">
                        <mat-icon>content_copy</mat-icon>
                        <span>Clone</span>
                    </button>
                    @if (trip.action != actionEnum.Delete) {
                        <button mat-menu-item [attr.color]="'warn'" (click)="confirmDeleteTripDialog(trip)">
                            <mat-icon color="warn">delete</mat-icon>
                            <span>Delete</span>
                        </button>
                    }
                    @else {
                        <button mat-menu-item [attr.color]="'primary'" (click)="restoreTrip(trip)">
                            <mat-icon color="primary">restore</mat-icon>
                            <span>Restore</span>
                        </button>
                    }
                </mat-menu>
            </div>
        </div>
    }

    <div class="row-grid">
        <app-trips-table-group class="table" title="{{ defaultSheet?.name }} - Trips" link="{{defaultSheet?.id}}" [days]=6></app-trips-table-group>
    </div>
</div>