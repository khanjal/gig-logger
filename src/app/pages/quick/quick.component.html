<div class="container">
    <form class="quick-form" [formGroup]="quickForm" (ngSubmit)="addTrip()">
        <mat-form-field appearance="fill" class="field-full-width">
            <mat-label>Shift</mat-label>
            <mat-select #shiftSelect name="shift" formControlName="shift" (selectionChange)='onShiftSelected(shiftSelect.value)' required>
                <mat-option value="new">New</mat-option>
                <mat-option *ngFor="let shift of shifts" [value]="shift">{{ shift.service }} {{ shift.shiftNumber == "" ? "" : '#' + shift.shiftNumber }} - {{ shift.date }}</mat-option>
            </mat-select>
        </mat-form-field>

        <div *ngIf="isNewShift">
            <mat-form-field class="field-full-width" appearance="fill">
                <mat-label>Service</mat-label>
                <input type="text"
                    name="service"
                    placeholder="Pick one"
                    aria-label="Number"
                    matInput
                    formControlName="service"
                    [matAutocomplete]="autoService"
                    required>
                <mat-autocomplete autoActiveFirstOption #autoService="matAutocomplete">
                <mat-option *ngFor="let service of filteredServices | async" [value]="service.service">
                    {{ service.service }} ({{ service.visits }})
                </mat-option>
                </mat-autocomplete>
            </mat-form-field>
        </div>

        <mat-form-field class="field-full-width" appearance="fill">
            <mat-label>Place</mat-label>
            <input type="text"
                name="place"
                placeholder="Pick one"
                aria-label="Number"
                matInput
                formControlName="place"
                [matAutocomplete]="autoPlace"
                required>
            <mat-autocomplete autoActiveFirstOption #autoPlace="matAutocomplete">
            <mat-option *ngFor="let place of filteredPlaces | async" [value]="place.place">
                {{place.place}} ({{ place.visits }})
            </mat-option>
            </mat-autocomplete>
        </mat-form-field>

        <mat-form-field class="field-quarter-width">
            <mat-label>Pay</mat-label>
            <input matInput name="amount" placeholder="4.5" formControlName="amount" value="" required>
        </mat-form-field>

        <mat-form-field class="field-halfish-width" appearance="fill">
            <mat-label>Name</mat-label>
            <input type="text"
                name="name"
                placeholder="Pick one"
                aria-label="Number"
                matInput
                formControlName="name"
                [matAutocomplete]="autoName"
                (blur)="showNameAddressesEvent($event)"
                (keypress)="showNameAddressesEvent($event)"
                required>
            <mat-autocomplete autoActiveFirstOption #autoName="matAutocomplete">
            <mat-option *ngFor="let name of filteredNames | async" [value]="name.name" (onSelectionChange)="showNameAddresses(name.name)">
                {{ name.name }} (V: {{ name.visits }}, A: {{ name?.addresses?.length }})
            </mat-option>
            </mat-autocomplete>
        </mat-form-field>

        <div *ngFor="let address of selectedName?.addresses">
            <a mat-button color="primary" class="address-link" (click)="selectAddress(address)">{{ address }}</a>
        </div>

        <mat-form-field class="field-full-width" appearance="fill">
            <mat-label>Address</mat-label>
            <input type="text"
                name="address"
                placeholder="Pick one"
                aria-label="Number"
                matInput
                formControlName="address"
                [matAutocomplete]="autoAddress"
                (blur)="showAddressNamesEvent($event)"
                (keypress)="showAddressNamesEvent($event)"
                required>
            <mat-autocomplete autoActiveFirstOption #autoAddress="matAutocomplete">
            <mat-option *ngFor="let address of filteredAddresses | async" [value]="address.address" (onSelectionChange)="showAddressNames(address.address)">
                {{address.short}} ({{ address.visits }})
            </mat-option>
            </mat-autocomplete>
        </mat-form-field>

        <div *ngIf="selectedAddress">
            <p *ngFor="let name of selectedAddress.names">{{ name }}</p>
        </div>

        <button mat-button type="submit" [disabled]="!quickForm.valid">Add Trip</button>
        <button mat-button color="primary" type="button" (click)="save()">Save to Spreadsheet</button>
        <button mat-button color="warn" type="button" (click)="reload()">Reload Data</button>
    </form>
</div>

<mat-divider></mat-divider>

<h3>Trips</h3>
<div class='table-responsive'>
    <mat-table [dataSource]="trips">
        <ng-container matColumnDef="saved">
            <mat-header-cell *matHeaderCellDef></mat-header-cell>
            <mat-cell *matCellDef="let trip"><mat-icon>{{trip.saved ? 'check' : 'close'}}</mat-icon>  </mat-cell>
        </ng-container>
        <ng-container matColumnDef="date">
            <mat-header-cell *matHeaderCellDef> Date </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.date}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="service">
            <mat-header-cell *matHeaderCellDef> Service </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.service}}{{ trip.shiftNumber ? '-' : ''}}{{ trip.shiftNumber}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="place">
            <mat-header-cell *matHeaderCellDef> Place </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.place}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="time">
            <mat-header-cell *matHeaderCellDef>Time</mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.time}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="amount">
            <mat-header-cell *matHeaderCellDef> Amount </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.saved ? trip.amount : trip.amount | currency}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef> Name </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.name}} </mat-cell>
        </ng-container>
        <ng-container matColumnDef="address">
            <mat-header-cell *matHeaderCellDef> Address </mat-header-cell>
            <mat-cell *matCellDef="let trip"> {{trip.address}} </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>
</div>
<div>
    <!-- <p *ngFor="let trip of trips">{{ trip.id }} | {{ trip.date }} | {{ trip.service }} | {{ trip.shiftNumber }} | {{ trip.place }} | {{ trip.name }} | {{ trip.address }}</p> -->
</div>