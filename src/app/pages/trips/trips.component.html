<div class="container" id="addTrip">
    <!-- Loading overlay for transitions and page loads -->
    @if (isLoading) {
        <div class="loading-overlay">
            <div class="loading-spinner">
                <mat-icon class="spinner-icon">refresh</mat-icon>
                <p>Loading...</p>
            </div>
        </div>
    }
    
    <div class="trip-form-container" [ngClass]="{'edit-mode': isEditMode}">
        <app-current-average class="current-average-overlay" [ngClass]="{'hidden': isEditMode}"></app-current-average>
        <trip-form 
            (parentReload)="load()" 
            (editModeExit)="exitEditMode($event)" 
            [isInEditMode]="isEditMode" 
            id="tripForm">
        </trip-form>
    </div>

    @if (unsavedData && !pollingEnabled && !isEditMode) {
        <div class="row-grid">
            <button mat-fab extended class="button" color="accent" [class.spinner]="saving" [disabled]="saving || defaultSheet?.id === demoSheetId" (click)="confirmSaveTripsDialog()"><mat-icon>save</mat-icon> Save Changes to Spreadsheet</button>
        </div>
    }

    @if ((!unsavedData || pollingEnabled) && !isEditMode) {
        <div class="row-grid">
            <button mat-fab extended color="primary" class="button" [class.spinner]="reloading" [disabled]="reloading || unsavedData"  (click)="confirmLoadTripsDialog()"><mat-icon>refresh</mat-icon> Update from Spreadsheet</button>
        </div>
    }

    <h2 id="todaysTrips" [ngClass]="{'hidden': isEditMode}">
        @if (todaysTrips.length > 0) {
            Today's Trips ({{todaysTrips.length}})
        }
        @else {
            No Trips Today
        }
        <mat-slide-toggle class="field-right" (change)="changePolling()">
            Auto Save
        </mat-slide-toggle>
    </h2>
    
    @if (!isEditMode) {
        @for (trip of todaysTrips; track $index) {
            <div [id]="trip.rowId" [ngClass]="{'mat-card': todaysTrips.length % 2 != 0, 'mat-card-reverse': todaysTrips.length % 2 == 0, 'mat-card-disabled': trip.exclude == true || trip.action == actionEnum.Delete}">
                <trips-quick-view [trip]="trip" (pollingToggle)="$event === true ? startPolling() : stopPolling()" (parentReload)="load()" (scrollToTrip)="scrollToTrip($event)"></trips-quick-view>
            </div>
        }
    }    <br/>
    @if (yesrterdaysTrips.length > 0 && !isEditMode) {
        <div class="yesterday-section">
            <h2 id="yesrterdaysTrips" class="yesterday-header clickable" (click)="toggleYesterdayTrips()">
                <mat-icon class="toggle-icon" [class.expanded]="showYesterdayTrips">
                    {{ showYesterdayTrips ? 'expand_less' : 'expand_more' }}
                </mat-icon>
                Yesterday's Trips ({{yesrterdaysTrips.length}})
                <span class="show-hide-label">{{ showYesterdayTrips ? 'Hide' : 'Show' }}</span>
            </h2>
            
            @if (showYesterdayTrips) {
                <div class="yesterday-trips-container">
                    @for (trip of yesrterdaysTrips; track $index) {
                        <div [id]="trip.rowId" [ngClass]="{'mat-card': yesrterdaysTrips.length % 2 != 0, 'mat-card-reverse': yesrterdaysTrips.length % 2 == 0, 'mat-card-disabled': trip.exclude == true || trip.action == actionEnum.Delete}">
                            <trips-quick-view [trip]="trip" (pollingToggle)="$event === true ? startPolling() : stopPolling()" (parentReload)="load()" (scrollToTrip)="scrollToTrip($event)"></trips-quick-view>
                        </div>
                    }
                </div>
            }
        </div>
    }
    <br/>
    @if (!isEditMode) {
        <div class="row-grid">
            <app-trips-table-group class="table" [title]="((defaultSheet?.name ?? 'Sheet') | truncate:25) + ' - Trips'" [link]="defaultSheet?.id ?? ''" [days]="6"></app-trips-table-group>
        </div>
    }

    <!-- Floating "Back to Top" button -->
    <button 
        mat-fab 
        color="primary" 
        class="back-to-top" 
        *ngIf="showBackToTop" 
        (click)="scrollToTop()"
        aria-label="Back to Top"
    >
        <mat-icon>arrow_upward</mat-icon>
    </button>
</div>

<style>
.yesterday-header.clickable {
    cursor: pointer;
    background: #f5f5f5;
    border-radius: 6px;
    padding: 8px 16px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    user-select: none;
}
.yesterday-header.clickable:hover {
    background: #e0e0e0;
}
.toggle-icon {
    margin-right: 8px;
    transition: transform 0.2s;
}
.toggle-icon.expanded {
    transform: rotate(180deg);
}
.show-hide-label {
    margin-left: 12px;
    font-size: 0.95em;
    color: #666;
    font-weight: 500;
}
</style>